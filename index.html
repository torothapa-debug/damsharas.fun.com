<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DAMSHARAS - Multiplayer Drawing Game</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
:root{--bg:#0b0d17;--bg2:#151829;--card:#1c2038;--inp:#252a45;--yel:#ffd23f;--grn:#4ade80;--blu:#60a5fa;--pnk:#f472b6;--pur:#a78bfa;--org:#fb923c;--red:#f87171;--txt:#e8eaf6;--txt2:#9ca3c4;--mut:#6b7194;--brd:#2d3260;--ok:#22c55e;--sh:0 8px 32px rgba(0,0,0,0.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(168,139,250,0.08),transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(96,165,250,0.06),transparent 50%);z-index:0;pointer-events:none}
.screen{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;position:relative;z-index:1;padding:20px}
.screen.active{display:flex}#gameScreen{padding:0}#gameScreen.active{display:block}
.logo{text-align:center;margin-bottom:28px;animation:fi .8s ease-out}
@keyframes fi{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
.logo h1{font-family:'Fredoka One',cursive;font-size:52px;background:linear-gradient(135deg,var(--yel),var(--org),var(--pnk),var(--pur));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 4px 8px rgba(255,210,63,0.3));letter-spacing:2px}
.logo p{font-size:15px;color:var(--txt2);margin-top:4px;letter-spacing:3px;text-transform:uppercase}
.card{background:var(--card);border:1px solid var(--brd);border-radius:20px;padding:32px;width:100%;max-width:460px;box-shadow:var(--sh);animation:fi .8s ease-out .2s both}
.card h2{font-family:'Fredoka One',cursive;font-size:21px;color:var(--yel);margin-bottom:20px;text-align:center}
.ig{margin-bottom:14px}.ig label{display:block;font-weight:700;font-size:12px;color:var(--txt2);margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}
.ig input,.ig select{width:100%;padding:11px 14px;border:2px solid var(--brd);border-radius:12px;background:var(--inp);color:var(--txt);font-family:'Nunito',sans-serif;font-size:15px;font-weight:600;outline:none;transition:border-color .3s}
.ig input:focus,.ig select:focus{border-color:var(--yel)}.ig select option{background:var(--card)}
.sr{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.avs{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
.avo{width:44px;height:44px;border-radius:50%;border:3px solid var(--brd);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all .2s;background:var(--inp)}
.avo:hover{transform:scale(1.15)}.avo.sel{border-color:var(--yel);box-shadow:0 0 12px rgba(255,210,63,0.4)}
.btn{width:100%;padding:14px;border:none;border-radius:14px;font-family:'Fredoka One',cursive;font-size:18px;cursor:pointer;transition:all .3s;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
.btn:last-child{margin-bottom:0}.btn:disabled{opacity:.4;pointer-events:none}
.btn-go{background:linear-gradient(135deg,var(--grn),#06b6d4);color:#0a1628;box-shadow:0 4px 20px rgba(74,222,128,0.3)}
.btn-go:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(74,222,128,0.45)}
.btn-cr{background:linear-gradient(135deg,var(--blu),var(--pur));color:#fff;box-shadow:0 4px 20px rgba(96,165,250,0.3)}
.btn-cr:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(96,165,250,0.45)}
.btn-pr{background:linear-gradient(135deg,var(--yel),var(--org));color:#1a1a2e;box-shadow:0 4px 20px rgba(255,210,63,0.3)}
.btn-pr:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(255,210,63,0.45)}
.btn-jn{background:linear-gradient(135deg,var(--org),var(--pnk));color:#fff;box-shadow:0 4px 20px rgba(251,146,60,0.3)}
.btn-jn:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(251,146,60,0.45)}
.btn-sc{background:var(--inp);color:var(--txt);border:2px solid var(--brd)}.btn-sc:hover{border-color:var(--org);transform:translateY(-2px)}
.join-expand{max-height:0;overflow:hidden;transition:max-height .4s ease,opacity .3s;opacity:0}
.join-expand.open{max-height:150px;opacity:1;margin-top:10px}
.btn-dn{background:rgba(248,113,113,0.15);color:var(--red);border:2px solid rgba(248,113,113,0.3);font-size:15px}.btn-dn:hover{background:rgba(248,113,113,0.25)}
.bdesc{font-size:11px;font-family:'Nunito',sans-serif;font-weight:600;opacity:.7}
.divider{display:flex;align-items:center;gap:14px;margin:14px 0;color:var(--mut);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:2px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--brd)}
.mbadge{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;font-family:'Nunito',sans-serif}
.mbadge.on{background:rgba(74,222,128,0.15);color:var(--grn)}.mbadge.loc{background:rgba(96,165,250,0.15);color:var(--blu)}.mbadge.pub{background:rgba(74,222,128,0.15);color:var(--grn)}
.spinner{width:48px;height:48px;border:4px solid var(--brd);border-top-color:var(--grn);border-radius:50%;animation:sp 1s linear infinite;margin:0 auto 16px}
@keyframes sp{to{transform:rotate(360deg)}}
.search-txt{font-size:16px;color:var(--txt2);margin-bottom:6px;font-weight:700;text-align:center}
.search-sub{font-size:12px;color:var(--mut);text-align:center}
.rcode{font-family:'Fredoka One',cursive;font-size:38px;letter-spacing:8px;color:var(--yel);background:var(--inp);border:2px dashed var(--yel);border-radius:16px;padding:14px 28px;display:inline-block;cursor:pointer;transition:all .2s;position:relative}
.rcode:hover{background:rgba(255,210,63,0.08)}.rcode.cp{border-color:var(--grn)}.rcode.ol{color:var(--blu);border-color:var(--blu)}
.rcode .ch{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:11px;color:var(--mut);font-family:'Nunito',sans-serif;letter-spacing:0;white-space:nowrap}
.rcode.cp .ch{color:var(--grn)}
.cs{font-size:12px;text-align:center;padding:8px;border-radius:10px;margin-bottom:12px}
.cs.cg{background:rgba(251,146,60,0.1);color:var(--org)}.cs.cd{background:rgba(74,222,128,0.1);color:var(--grn)}.cs.ce{background:rgba(248,113,113,0.1);color:var(--red)}
.wps{display:flex;flex-direction:column;gap:6px;margin:12px 0;max-height:220px;overflow-y:auto}
.wp{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--inp);border-radius:12px;border:1px solid var(--brd);animation:mi .2s ease-out}
.wp .wa{font-size:20px}.wp .wn{font-weight:700;flex:1;font-size:14px}
.wb{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:2px 7px;border-radius:5px}
.wb.host{background:rgba(255,210,63,0.15);color:var(--yel)}.wb.you{background:rgba(96,165,250,0.15);color:var(--blu)}
.pc{font-size:13px;color:var(--mut);text-align:center;margin:6px 0}

/* GAME */
.tb{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--brd);height:60px}
.tbl{display:flex;align-items:center;gap:16px}
.gl{font-family:'Fredoka One',cursive;font-size:22px;background:linear-gradient(135deg,var(--yel),var(--org));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.ri{font-weight:700;color:var(--txt2);font-size:13px}.ri span{color:var(--blu)}
.tbc{display:flex;align-items:center;gap:14px}
.tc{width:44px;height:44px;border-radius:50%;border:3px solid var(--blu);display:flex;align-items:center;justify-content:center;font-family:'Fredoka One',cursive;font-size:18px;color:var(--blu);transition:all .3s}
.tc.w{border-color:var(--org);color:var(--org)}.tc.d{border-color:var(--red);color:var(--red);animation:pu .5s infinite}
@keyframes pu{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.wd{font-family:'Fredoka One',cursive;font-size:26px;letter-spacing:6px;color:var(--txt);min-width:180px;text-align:center}.wd.hn{color:var(--yel)}
.tbr{display:flex;align-items:center;gap:8px}
.bi{width:36px;height:36px;border-radius:10px;border:1px solid var(--brd);background:var(--card);color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s}
.bi:hover{border-color:var(--yel);color:var(--yel)}
.gm{display:grid;grid-template-columns:200px 1fr 280px;height:calc(100vh - 60px)}
.pp{background:var(--bg2);border-right:1px solid var(--brd);overflow-y:auto;padding:8px}
.pcard{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;margin-bottom:5px;background:var(--card);border:1px solid transparent;transition:all .3s;position:relative}
.pcard.dr{border-color:var(--yel);background:rgba(255,210,63,0.08)}.pcard.gu{border-color:var(--ok);background:rgba(34,197,94,0.08)}.pcard.sp{border-color:var(--pur);background:rgba(167,139,250,0.1)}
.pav{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;position:relative}
.pcard.sp .pav::after{content:'';position:absolute;inset:-4px;border-radius:50%;border:2px solid var(--pur);animation:vr .8s ease-out infinite}
@keyframes vr{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}
.pi{flex:1;min-width:0}.pn{font-weight:700;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ps{font-size:10px;color:var(--mut);font-weight:600}
.pr{font-family:'Fredoka One',cursive;font-size:13px;color:var(--yel);width:22px;text-align:center}
.di{position:absolute;top:4px;right:6px;font-size:12px;animation:bo 1s infinite}.vi{position:absolute;bottom:4px;right:6px;font-size:10px;color:var(--pur)}
@keyframes bo{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.ca{display:flex;flex-direction:column;background:var(--bg);position:relative}
.cw{flex:1;display:flex;align-items:center;justify-content:center;padding:8px}
#drawCanvas{background:#fff;border-radius:12px;cursor:crosshair;box-shadow:0 4px 30px rgba(0,0,0,0.5);max-width:100%;max-height:100%}
.tbar{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;background:var(--bg2);border-top:1px solid var(--brd);flex-wrap:wrap}
.tbar.off{opacity:.3;pointer-events:none}
.cp{display:flex;gap:3px;flex-wrap:wrap;max-width:300px}
.cb{width:26px;height:26px;border-radius:5px;border:2px solid transparent;cursor:pointer;transition:all .15s}
.cb:hover{transform:scale(1.2)}.cb.sel{border-color:white;box-shadow:0 0 8px rgba(255,255,255,0.4);transform:scale(1.15)}
.ts{width:1px;height:30px;background:var(--brd);margin:0 3px}
.tbtn{width:34px;height:34px;border-radius:8px;border:2px solid var(--brd);background:var(--card);color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s}
.tbtn:hover{border-color:var(--blu);color:var(--blu)}.tbtn.sel{border-color:var(--yel);color:var(--yel);background:rgba(255,210,63,0.1)}
.bs{display:flex;gap:5px;align-items:center}
.bsb{border-radius:50%;border:2px solid var(--brd);background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.bsb .dot{border-radius:50%;background:var(--txt2)}.bsb.sel{border-color:var(--yel)}.bsb.sel .dot{background:var(--yel)}
.rp{display:flex;flex-direction:column;border-left:1px solid var(--brd);background:var(--bg2)}
.ptabs{display:flex;border-bottom:1px solid var(--brd);background:var(--card)}
.ptab{flex:1;padding:10px 8px;text-align:center;font-weight:800;font-size:12px;color:var(--mut);cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:1px;border-bottom:3px solid transparent;user-select:none}
.ptab:hover{color:var(--txt2)}.ptab.act{color:var(--yel);border-bottom-color:var(--yel)}
.chp{flex:1;display:flex;flex-direction:column;overflow:hidden}.chp.hid{display:none}
.cms{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:3px}
.cm{padding:5px 10px;border-radius:8px;font-size:12px;animation:mi .2s ease-out;word-break:break-word}
@keyframes mi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.cm.sys{color:var(--mut);font-style:italic;text-align:center;font-size:11px}
.cm.cor{background:rgba(34,197,94,0.12);color:var(--ok);font-weight:700;text-align:center;border:1px solid rgba(34,197,94,0.2)}
.cm.pm{background:var(--card)}.cm.pm .ma{font-weight:800;margin-right:5px}
.cm.cl{background:rgba(251,146,60,0.12);color:var(--org);font-weight:600;text-align:center}
.cm.vm{border-left:3px solid var(--pur)}
.vbdg{display:inline-block;background:var(--pur);color:#fff;font-size:8px;font-weight:800;padding:1px 4px;border-radius:3px;margin-left:4px;vertical-align:middle}
.cia{padding:8px;border-top:1px solid var(--brd)}
.cia input{width:100%;padding:10px 14px;border:2px solid var(--brd);border-radius:12px;background:var(--inp);color:var(--txt);font-family:'Nunito',sans-serif;font-size:13px;font-weight:600;outline:none;transition:border-color .3s}
.cia input:focus{border-color:var(--blu)}.cia input:disabled{opacity:.4}
.vp{flex:1;display:none;flex-direction:column;overflow:hidden}.vp.act{display:flex}
.vsb{padding:8px 12px;display:flex;align-items:center;gap:7px;border-bottom:1px solid var(--brd);font-size:11px;color:var(--txt2)}
.vsd{width:7px;height:7px;border-radius:50%;background:var(--mut);flex-shrink:0}.vsd.cn{background:var(--grn);box-shadow:0 0 6px rgba(74,222,128,0.5)}
.vmem{flex:1;overflow-y:auto;padding:8px}
.vm{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;margin-bottom:5px;background:var(--card);border:1px solid transparent;transition:all .3s}
.vm.sa{border-color:var(--pur);background:rgba(167,139,250,0.08)}
.vma{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;position:relative}
.vma .vrg{display:none;position:absolute;inset:-3px;border-radius:50%;border:2px solid var(--pur)}.vm.sa .vrg{display:block;animation:vr .8s ease-out infinite}
.vmi{flex:1}.vmn{font-weight:700;font-size:12px}.vms{font-size:10px;color:var(--mut)}
.vc{padding:12px;border-top:1px solid var(--brd);display:flex;flex-direction:column;gap:8px}
.vviz{height:36px;display:flex;align-items:flex-end;justify-content:center;gap:2px;padding:3px 0}
.vzb{width:3px;background:var(--brd);border-radius:2px;transition:height .08s ease;min-height:3px}
.vbs{display:flex;gap:6px;align-items:center}
.bv{flex:1;padding:10px;border:2px solid var(--brd);border-radius:10px;background:var(--card);color:var(--txt);font-family:'Nunito',sans-serif;font-weight:700;font-size:12px;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;gap:5px}
.bv:hover{border-color:var(--pur)}.bv.ma{border-color:var(--pur);background:rgba(167,139,250,0.15);color:var(--pur);box-shadow:0 0 16px rgba(167,139,250,0.2)}
.bv.ma.li{animation:mp 1.5s ease-in-out infinite}
@keyframes mp{0%,100%{box-shadow:0 0 16px rgba(167,139,250,0.2)}50%{box-shadow:0 0 28px rgba(167,139,250,0.45)}}
.bvs{width:38px;height:38px;border:2px solid var(--brd);border-radius:8px;background:var(--card);color:var(--txt2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0}
.bvs:hover{border-color:var(--pur);color:var(--pur)}.bvs.act{border-color:var(--red);color:var(--red)}
.vmt{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--brd)}
.vmb{flex:1;padding:5px 8px;font-size:10px;font-weight:700;text-align:center;cursor:pointer;background:var(--inp);color:var(--mut);transition:all .2s;border:none;text-transform:uppercase;letter-spacing:.5px}
.vmb.act{background:var(--pur);color:#fff}
.vtr{font-size:11px;color:var(--mut);text-align:center;min-height:16px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.vtr.act{color:var(--pur);font-style:normal}
.vhn{font-size:10px;color:var(--mut);text-align:center}

.ov{display:none;position:fixed;inset:0;background:rgba(11,13,23,0.85);backdrop-filter:blur(8px);z-index:100;align-items:center;justify-content:center}
.ov.act{display:flex}
.oc{background:var(--card);border:1px solid var(--brd);border-radius:24px;padding:36px;text-align:center;box-shadow:var(--sh);animation:pi .4s cubic-bezier(0.34,1.56,0.64,1);min-width:360px;max-width:500px}
@keyframes pi{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
.oc h2{font-family:'Fredoka One',cursive;font-size:22px;color:var(--yel);margin-bottom:18px}
.wos{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.wo{padding:14px 28px;border:2px solid var(--brd);border-radius:14px;background:var(--inp);color:var(--txt);font-family:'Fredoka One',cursive;font-size:17px;cursor:pointer;transition:all .3s}
.wo:hover{border-color:var(--yel);background:rgba(255,210,63,0.1);transform:translateY(-4px)}
.wrv{font-size:15px;color:var(--txt2);margin-bottom:20px}.wrv span{color:var(--yel);font-weight:800}
.sl{display:flex;flex-direction:column;gap:6px;margin-bottom:20px}
.si{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--inp);border-radius:8px;font-size:13px}
.si .sn{font-weight:700}.si .sp{color:var(--grn);font-weight:800}
.gop h1{font-family:'Fredoka One',cursive;font-size:32px;background:linear-gradient(135deg,var(--yel),var(--org));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
.gop .wi{font-size:16px;color:var(--txt2);margin-bottom:24px}.gop .wn{color:var(--yel);font-weight:800;font-size:20px}
.fs{display:flex;flex-direction:column;gap:6px;margin-bottom:24px}
.fi{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--inp);border-radius:10px}.fi.f1{border:2px solid var(--yel);background:rgba(255,210,63,0.08)}
.fr{font-family:'Fredoka One',cursive;font-size:16px;width:28px}.fr.g{color:var(--yel)}.fr.s{color:#c0c0c0}.fr.b{color:#cd7f32}
.fn{flex:1;text-align:left;font-weight:700;font-size:14px}
.fp{font-family:'Fredoka One',cursive;color:var(--grn);font-size:16px}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
@media(max-width:900px){.gm{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}.pp{display:flex;overflow-x:auto;border-right:none;border-bottom:1px solid var(--brd);padding:5px;gap:5px}.pcard{min-width:120px;margin-bottom:0}.rp{max-height:240px}.logo h1{font-size:36px}}
</style>
</head>
<body>
<!-- HOME -->
<div class="screen active" id="homeScreen">
<div class="logo"><h1>DAMSHARAS</h1><p>Drawing &amp; Guessing Game</p></div>
<div class="card">
<h2>üé® Let's Play!</h2>
<div class="ig"><label>Your Name</label><input type="text" id="playerName" placeholder="Enter your name..." maxlength="16"></div>
<div class="ig"><label>Choose Avatar</label><div class="avs" id="avatarSel"></div></div>
<button class="btn btn-go" onclick="playOnline()">üåê Play Online<span class="bdesc">Find random players</span></button>
<button class="btn btn-cr" onclick="createRoom()">üè† Create a Room<span class="bdesc">Private room with code</span></button>
<button class="btn btn-jn" onclick="toggleJoin()">üö™ Join a Room<span class="bdesc">Enter a room code</span></button>
<div class="join-expand" id="joinExpand">
<div class="ig" style="margin-bottom:10px"><input type="text" id="joinCode" placeholder="Enter room code..." maxlength="8" style="text-transform:uppercase;letter-spacing:3px;text-align:center;font-family:'Fredoka One',cursive;font-size:18px"></div>
<button class="btn btn-sc" onclick="joinRoom()" style="font-size:15px;padding:12px">‚û°Ô∏è Connect</button>
</div>
</div></div>

<!-- WAITING -->
<div class="screen" id="waitingScreen">
<div class="logo"><h1>DAMSHARAS</h1><p>Waiting Room</p></div>
<div class="card">
<h2 id="wTitle">üè† Your Room</h2>
<div class="cs" id="connSt" style="display:none"></div>
<div id="searchPanel" style="display:none;text-align:center;padding:20px 0"><div class="spinner"></div><div class="search-txt" id="sTxt">Searching for players...</div><div class="search-sub" id="sSub">Looking for open lobbies...</div></div>
<div id="codeSection" style="text-align:center;margin:16px 0"><label style="display:block;font-size:12px;color:var(--txt2);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-weight:700">Share this code</label><div class="rcode" id="rcodeDisp" onclick="copyCode()"><span id="rcodeTxt">------</span><span class="ch" id="copyHint">Click to copy</span></div></div>
<div style="text-align:center;margin:6px 0"><span class="mbadge" id="mBadge">LOCAL</span></div>
<div class="pc" id="pCount">1 player</div>
<div class="wps" id="wPlayers"></div>
<div class="sr" id="hostSet"><div class="ig"><label>Rounds</label><select id="rndSel"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div><div class="ig"><label>Draw Time</label><select id="dtSel"><option value="40">40s</option><option value="60">60s</option><option value="80" selected>80s</option><option value="100">100s</option><option value="120">120s</option></select></div></div>
<button class="btn btn-pr" id="startBtn" onclick="hostStart()" disabled>‚è≥ Waiting...</button>
<button class="btn btn-dn" onclick="leave()" style="width:100%;margin-top:8px;font-size:14px;padding:10px">Leave Room</button>
<p style="font-size:10px;color:var(--mut);text-align:center;margin-top:10px" id="wHint"></p>
</div></div>

<!-- GAME -->
<div class="screen" id="gameScreen">
<div class="tb"><div class="tbl"><div class="gl">DAMSHARAS</div><div class="ri">Round <span id="rNum">1</span> of <span id="tRnds">3</span></div></div><div class="tbc"><div class="tc" id="tmr">80</div><div class="wd" id="wDisp">_ _ _ _ _</div></div><div class="tbr"><button class="bi" onclick="togSnd()">üîä</button></div></div>
<div class="gm">
<div class="pp" id="pList"></div>
<div class="ca"><div class="cw"><canvas id="drawCanvas" width="780" height="520"></canvas></div>
<div class="tbar" id="toolb"><div class="cp" id="colPal"></div><div class="ts"></div><div class="bs" id="brSz"></div><div class="ts"></div>
<button class="tbtn" id="bPen" onclick="setT('pencil')">‚úèÔ∏è</button><button class="tbtn" id="bEra" onclick="setT('eraser')">üßπ</button><button class="tbtn" id="bFil" onclick="setT('fill')">ü™£</button><button class="tbtn" onclick="undo()">‚Ü©Ô∏è</button><button class="tbtn" onclick="clr()">üóëÔ∏è</button></div></div>
<div class="rp">
<div class="ptabs"><div class="ptab act" id="tChat" onclick="swTab('chat')">üí¨ Chat</div><div class="ptab" id="tVoice" onclick="swTab('voice')">üéôÔ∏è Voice</div></div>
<div class="chp" id="chatP"><div class="cms" id="chatMsgs"></div><div class="cia"><input type="text" id="chatIn" placeholder="Type your guess..." maxlength="50" autocomplete="off"></div></div>
<div class="vp" id="voiceP"><div class="vsb"><div class="vsd" id="vsDot"></div><span id="vsTxt">Disconnected</span></div><div class="vmem" id="vMems"></div>
<div class="vc"><div class="vviz" id="vViz"></div><div class="vtr" id="vTr">Press mic to start</div><div class="vmt"><button class="vmb act" id="mTog" onclick="togVM('toggle')">Toggle</button><button class="vmb" id="mPTT" onclick="togVM('ptt')">PTT</button></div><div class="vbs"><button class="bv" id="bMic" onclick="togMic()"><span>üéôÔ∏è</span><span id="micLbl">Start Mic</span></button><button class="bvs" id="bMut" onclick="togMut()">üîà</button></div><div class="vhn" id="vHn">Speak guesses ‚Äî auto-submits!</div></div></div>
</div></div></div>

<!-- OVERLAYS -->
<div class="ov" id="wSelOv"><div class="oc"><h2>‚ú® Choose a word!</h2><div class="wos" id="wOpts"></div></div></div>
<div class="ov" id="rResOv"><div class="oc"><h2 id="rResT">‚è∞ Time's Up!</h2><div class="wrv">The word was: <span id="revW"></span></div><div class="sl" id="rScores"></div></div></div>
<div class="ov" id="goOv"><div class="oc gop"><h1>üèÜ Game Over!</h1><div class="wi">Winner: <span class="wn" id="winN"></span></div><div class="fs" id="fScores"></div><button class="btn btn-pr" onclick="backLobby()">Play Again</button></div></div>

<script>
const WORDS=["apple","banana","car","dog","elephant","fish","guitar","house","ice cream","jacket","kite","lion","moon","notebook","ocean","pizza","queen","rainbow","sun","tree","umbrella","volcano","whale","xylophone","yacht","zebra","airplane","butterfly","castle","diamond","eagle","flower","ghost","hamburger","island","jellyfish","kangaroo","lighthouse","mountain","necklace","octopus","penguin","robot","snowflake","telescope","unicorn","violin","waterfall","computer","dragon","firework","giraffe","helicopter","igloo","jungle","keyboard","lemon","mushroom","ninja","parachute","sandwich","tornado","wizard","astronaut","bicycle","cactus","dolphin","feather","grapes","hammer","lamp","magnet","orange","pillow","rocket","scissors","trophy","anchor","bridge","candle","drum","envelope","frog","globe","heart","insect","jewel","ladder","mirror","nest","paint","ring","skull","sword","tent","vacuum","window","arrow","battery","cherry","dice","egg","flag","glasses","harp","iron","jar","key","leaf","medal","net","owl","pearl","quilt","rope","snake","tiger","vase","watch","angel","boat","crown","door","earth","forest","garden","horse","iceberg","juice","king","library","marble","nurse","present","star","train","village","waffle","camera","dinosaur","emerald","football","gorilla","headphones","koala","lollipop","mermaid","newspaper","ostrich","pineapple","raccoon","satellite","trampoline","walrus","basketball","caterpillar","dragonfly","flamingo","grasshopper","harmonica","marshmallow","origami","platypus","rhinoceros","scarecrow","thunderstorm","watermelon","broccoli","chandelier","fireplace","goldfish","hummingbird","chameleon","sunflower","surfboard","treasure","skateboard","spaceship","starfish","strawberry","superhero","toothbrush"];
const AVS=["üòÄ","üòé","ü§ì","ü•≥","üò∫","ü¶ä","üê∏","üêµ","üëª","ü§ñ","üëΩ","üéÉ","ü¶Ñ","üêº","üêß","ü¶Å"];
const COLS=["#000000","#555555","#8B4513","#FF0000","#FF8C00","#FFD700","#008000","#00CED1","#0000FF","#8A2BE2","#FF1493","#FFFFFF","#AAAAAA","#D2691E","#FF6347","#FFA500","#FFFF00","#7CFC00","#00FFFF","#1E90FF","#9370DB","#FF69B4"];
const BSZ=[{s:3,d:6},{s:6,d:10},{s:12,d:16},{s:22,d:22},{s:36,d:28}];
const PUB_PFX='damsharas-pub-',MAX_PUB=20,myId=crypto.randomUUID();
let myName='',myAvatar='üòÄ',searchAborted=false;

class Net{
  constructor(){this.onMsg=null;this.mode=null;this.bc=null;this.peer=null;this.conns=[];this.hc=null;this.isHost=false}
  cL(c){this.mode='local';this.isHost=true;this.bc=new BroadcastChannel('d_'+c);this.bc.onmessage=e=>{if(e.data.sid!==myId&&this.onMsg)this.onMsg(e.data)};return Promise.resolve()}
  jL(c){this.mode='local';this.isHost=false;this.bc=new BroadcastChannel('d_'+c);this.bc.onmessage=e=>{if(e.data.sid!==myId&&this.onMsg)this.onMsg(e.data)};return Promise.resolve()}
  cO(c){this.mode='online';this.isHost=true;return new Promise((r,j)=>{this.peer=new Peer('dm-'+c,{debug:0});this.peer.on('open',()=>{this.peer.on('connection',cn=>{cn.on('open',()=>{this.conns.push(cn);cn.on('data',d=>{if(d.sid!==myId){if(this.onMsg)this.onMsg(d);this.conns.forEach(x=>{if(x!==cn&&x.open)x.send(d)})}});cn.on('close',()=>{this.conns=this.conns.filter(x=>x!==cn)})})});r()});this.peer.on('error',e=>j(e));setTimeout(()=>j('timeout'),15000)})}
  jO(c){this.mode='online';this.isHost=false;return new Promise((r,j)=>{this.peer=new Peer(undefined,{debug:0});this.peer.on('open',()=>{this.hc=this.peer.connect('dm-'+c,{reliable:true});this.hc.on('open',()=>{this.hc.on('data',d=>{if(d.sid!==myId&&this.onMsg)this.onMsg(d)});r()});this.hc.on('error',e=>j(e));setTimeout(()=>j('timeout'),10000)});this.peer.on('error',e=>j(e))})}
  tx(m){m.sid=myId;if(this.mode==='local'&&this.bc)this.bc.postMessage(m);else if(this.mode==='online'){if(this.isHost)this.conns.forEach(c=>{if(c.open)c.send(m)});else if(this.hc?.open)this.hc.send(m)}}
  kill(){if(this.bc){this.bc.close();this.bc=null}if(this.peer){this.peer.destroy();this.peer=null}this.conns=[];this.hc=null;this.mode=null}
}
let net=new Net();
let R={code:null,mode:null,isHost:false,hid:null,ps:[],isPub:false};
let G={ps:[],cw:'',rn:1,tr:3,dt:80,tl:80,ti:null,gp:new Set(),to:[],idx:0,snd:true,hr:[],ph:'lobby',sp:new Set()};
let cv,cx,dw=false,cc='#000000',cs=6,ct='pencil',dh=[],sd=[];
let V={rec:null,on:false,mode:'toggle',muted:false,ms:null,ac:null,an:null,vb:24,vf:null,cn:false,ptt:false};

function ss(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function initAv(){const c=document.getElementById('avatarSel');c.innerHTML='';AVS.forEach((a,i)=>{const d=document.createElement('div');d.className='avo'+(i===0?' sel':'');d.textContent=a;d.onclick=()=>{c.querySelectorAll('.avo').forEach(e=>e.classList.remove('sel'));d.classList.add('sel')};c.appendChild(d)})}
function gc(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<6;i++)r+=c[Math.floor(Math.random()*c.length)];return r}
function toggleJoin(){const el=$('joinExpand');el.classList.toggle('open');if(el.classList.contains('open'))setTimeout(()=>$('joinCode').focus(),300)}
function gMe(){myName=document.getElementById('playerName').value.trim()||'Player';myAvatar=document.querySelector('.avo.sel')?.textContent||'üòÄ';return{id:myId,name:myName,avatar:myAvatar,score:0}}

// PLAY ONLINE
async function playOnline(){
  const me=gMe();searchAborted=false;ss('waitingScreen');
  $('searchPanel').style.display='block';$('codeSection').style.display='none';$('hostSet').style.display='none';$('startBtn').style.display='none';
  $('wTitle').textContent='üåê Finding a Game...';$('mBadge').className='mbadge pub';$('mBadge').textContent='üåê PUBLIC';
  $('wHint').textContent='Searching for open lobbies...';$('connSt').style.display='none';R.ps=[me];renderW();
  for(let i=0;i<MAX_PUB;i++){if(searchAborted)return;$('sSub').textContent=`Trying lobby ${i+1}/${MAX_PUB}...`;
    try{net.kill();net=new Net();await net.jO(PUB_PFX+i);R.code=PUB_PFX+i;R.mode='online';R.isHost=false;R.isPub=true;
      net.onMsg=onNet;net.tx({type:'join',player:me});
      $('searchPanel').style.display='none';$('codeSection').style.display='none';$('wTitle').textContent='üåê Joined Public Game!';
      $('wHint').textContent='Waiting for host to start...';$('connSt').style.display='block';$('connSt').className='cs cd';$('connSt').textContent='‚úÖ Connected to public lobby!';renderW();return}catch(e){}}
  if(searchAborted)return;$('sSub').textContent='Creating new lobby...';
  for(let i=0;i<MAX_PUB;i++){if(searchAborted)return;
    try{net.kill();net=new Net();await net.cO(PUB_PFX+i);R.code=PUB_PFX+i;R.mode='online';R.isHost=true;R.hid=myId;R.isPub=true;R.ps=[me];
      net.onMsg=onNet;net.tx({type:'rs',ps:R.ps,hid:R.hid});
      $('searchPanel').style.display='none';$('codeSection').style.display='none';$('wTitle').textContent='üåê Public Lobby';
      $('wHint').textContent='You are host! Waiting for players...';$('connSt').style.display='block';$('connSt').className='cs cd';$('connSt').textContent='‚úÖ Lobby created!';
      $('hostSet').style.display='grid';$('startBtn').style.display='flex';renderW();return}catch(e){}}
  $('searchPanel').style.display='none';$('connSt').style.display='block';$('connSt').className='cs ce';$('connSt').textContent='‚ùå All lobbies full. Try Create a Room!'
}

// CREATE ROOM
async function createRoom(){
  const me=gMe();R.code=gc();R.mode='online';R.isHost=true;R.hid=myId;R.ps=[me];R.isPub=false;
  ss('waitingScreen');$('searchPanel').style.display='none';$('codeSection').style.display='block';
  const cs=$('connSt');cs.style.display='block';cs.className='cs cg';cs.textContent='üîÑ Setting up...';
  try{await net.cO(R.code);cs.className='cs cd';cs.textContent='‚úÖ Online room ready!';$('mBadge').className='mbadge on';$('mBadge').textContent='üåê ONLINE';$('wHint').textContent='üí° Share the code ‚Äî friends join from any device!'}
  catch(e){net.kill();net=new Net();await net.cL(R.code);R.mode='local';cs.className='cs cd';cs.textContent='‚úÖ Local room ready';$('mBadge').className='mbadge loc';$('mBadge').textContent='üè† LOCAL';$('wHint').textContent='üí° Open another tab & join with the code!'}
  $('rcodeDisp').className='rcode'+(R.mode==='online'?' ol':'');
  net.onMsg=onNet;net.tx({type:'rs',ps:R.ps,hid:R.hid});$('wTitle').textContent='üè† Your Room';renderW()
}

// JOIN
async function joinRoom(){
  const code=document.getElementById('joinCode').value.trim().toUpperCase();if(code.length<4){alert('Enter a valid code!');return}
  const me=gMe();R.code=code;R.isHost=false;R.isPub=false;ss('waitingScreen');$('searchPanel').style.display='none';$('codeSection').style.display='block';
  const cs=$('connSt');cs.style.display='block';cs.className='cs cg';cs.textContent='üîÑ Connecting...';R.ps=[me];renderW();
  try{await net.jO(code);R.mode='online';cs.className='cs cd';cs.textContent='‚úÖ Connected online!';$('mBadge').className='mbadge on';$('mBadge').textContent='üåê ONLINE';net.onMsg=onNet;net.tx({type:'join',player:me});renderW();return}catch(e){}
  try{net.kill();net=new Net();await net.jL(code);R.mode='local';cs.className='cs cd';cs.textContent='‚úÖ Connected locally!';$('mBadge').className='mbadge loc';$('mBadge').textContent='üè† LOCAL';net.onMsg=onNet;net.tx({type:'join',player:me});setTimeout(()=>net.tx({type:'rq',from:me}),300);renderW()}
  catch(e2){cs.className='cs ce';cs.textContent='‚ùå Room not found.'}
}

function $(id){return document.getElementById(id)}

function onNet(m){switch(m.type){
  case'join':if(R.isHost){if(!R.ps.find(p=>p.id===m.player.id))R.ps.push(m.player);net.tx({type:'rs',ps:R.ps,hid:R.hid});renderW()}break;
  case'rq':if(R.isHost)net.tx({type:'rs',ps:R.ps,hid:R.hid});break;
  case'rs':R.ps=m.ps;R.hid=m.hid;if(!R.ps.find(p=>p.id===myId)){R.ps.push(gMe())}renderW();break;
  case'sg':G.tr=m.r;G.dt=m.d;G.to=m.to;R.ps=m.ps;startG();break;
  case'dd':if(m.a==='s')rpS(m.d);else if(m.a==='c'&&cx){cx.fillStyle='#fff';cx.fillRect(0,0,cv.width,cv.height)}else if(m.a==='f')rpF(m.d);else if(m.a==='u')rpU(m.d);break;
  case'gs':remoteGs(m);break;
  case'gc':G.gp.add(m.pi);G.ps=m.sc||G.ps;playOk();addC('cor',`üéâ ${m.pn} guessed it! (+${m.pt})`);if(m.pi===myId){$('chatIn').disabled=true;$('chatIn').placeholder='You guessed it! ‚úÖ'}renderP();break;
  case'ch':addC('pm',m.t,m.a,m.v);break;
  case'cg':addC('cl',m.t);break;
  case'ts':hTS(m);break;
  case'wc':hWC(m);break;
  case'te':hTE(m);break;
  case'go':hGO(m);break;
  case'ht':hHt(m);break;
  case'pl':R.ps=R.ps.filter(p=>p.id!==m.pi);G.ps=G.ps.filter(p=>p.id!==m.pi);renderW();renderP();addC('sys',m.pn+' left.');break;
  case'sk':if(m.o)G.sp.add(m.pi);else G.sp.delete(m.pi);renderP();renderVM();break;
}}

function renderW(){$('rcodeTxt').textContent=R.code||'------';$('pCount').textContent=R.ps.length+' player'+(R.ps.length!==1?'s':'')+' in room';
  const c=$('wPlayers');c.innerHTML='';R.ps.forEach(p=>{const d=document.createElement('div');d.className='wp';let b='';if(p.id===R.hid)b+='<span class="wb host">üëë Host</span>';if(p.id===myId)b+='<span class="wb you">You</span>';d.innerHTML=`<span class="wa">${p.avatar}</span><span class="wn">${p.name}</span>${b}`;c.appendChild(d)});
  const ih=R.hid===myId;if(!R.isPub||ih)$('hostSet').style.display=ih?'grid':'none';
  const b=$('startBtn');if(!R.isPub||ih)b.style.display=ih?'flex':'none';b.disabled=R.ps.length<2;b.textContent=R.ps.length<2?'‚è≥ Waiting for players...':'üéÆ START ('+R.ps.length+')'}
function copyCode(){navigator.clipboard?.writeText(R.code);$('rcodeDisp').classList.add('cp');$('copyHint').textContent='Copied!';setTimeout(()=>{$('rcodeDisp').classList.remove('cp');$('copyHint').textContent='Click to copy'},2000)}
function leave(){searchAborted=true;net.tx({type:'pl',pi:myId,pn:myName});net.kill();net=new Net();R={code:null,mode:null,isHost:false,hid:null,ps:[],isPub:false};ss('homeScreen')}

function hostStart(){const to=R.ps.map(p=>p.id).sort(()=>Math.random()-.5);const r=+$('rndSel').value,d=+$('dtSel').value;const ps=R.ps.map(p=>({...p,score:0}));net.tx({type:'sg',ps,to,r,d});G.tr=r;G.dt=d;G.to=to;R.ps=ps;startG()}
function startG(){G.ps=R.ps.map(p=>({...p,score:p.score||0}));G.rn=1;G.idx=0;G.ph='play';ss('gameScreen');initCv();initTb();initVz();renderP();renderVM();$('tRnds').textContent=G.tr;$('chatMsgs').innerHTML='';addC('sys','Game started!');if(R.hid===myId)hST()}
function aID(){return G.to[G.idx]===myId}function gDI(){return G.to[G.idx]}

function hST(){G.gp=new Set();G.hr=[];G.sp=new Set();const di=gDI(),ws=[...WORDS].sort(()=>Math.random()-.5).slice(0,3);net.tx({type:'ts',di,rn:G.rn,ws:di===myId?ws:undefined,wfd:ws});hTS({di,rn:G.rn,ws:di===myId?ws:undefined,wfd:di===myId?ws:undefined})}
function hTS(m){G.gp=new Set();G.hr=[];G.sp=new Set();G.cw='';G.rn=m.rn||G.rn;if(cx){cx.fillStyle='#fff';cx.fillRect(0,0,cv.width,cv.height)}dh=[];if(cx)svH();const dr=G.ps.find(p=>p.id===m.di);$('rNum').textContent=G.rn;addC('sys',(dr?.name||'?')+' is drawing!');renderP();$('toolb').classList.toggle('off',!aID());$('chatIn').disabled=aID();$('chatIn').placeholder=aID()?'You are drawing!':'Type your guess...';if(aID()){const w=m.ws||m.wfd;if(w)showWS(w)}else{$('wDisp').textContent='? ? ?';$('wDisp').classList.remove('hn')}}
function showWS(ws){const c=$('wOpts');c.innerHTML='';ws.forEach(w=>{const b=document.createElement('div');b.className='wo';b.textContent=w;b.onclick=()=>{G.cw=w;$('wSelOv').classList.remove('act');$('wDisp').textContent=G.cw;$('wDisp').classList.remove('hn');net.tx({type:'wc',wl:w.length});startTm()};c.appendChild(b)});$('wSelOv').classList.add('act')}
function hWC(m){let s='';for(let i=0;i<m.wl;i++)s+='_ ';$('wDisp').textContent=s.trim();$('wDisp').classList.remove('hn');if(!aID())startTm()}
function startTm(){G.tl=G.dt;const t=$('tmr');t.textContent=G.tl;t.className='tc';clearInterval(G.ti);G.ti=setInterval(()=>{G.tl--;t.textContent=G.tl;t.className=G.tl<=10?'tc d':G.tl<=20?'tc w':'tc';if(G.tl<=5)playTk();if(R.hid===myId){if(G.tl===Math.floor(G.dt*.5)||G.tl===Math.floor(G.dt*.25))sndHt();const nd=G.ps.filter(p=>p.id!==gDI());if(nd.every(p=>G.gp.has(p.id))){hET(true);return}if(G.tl<=0){hET(false);return}}if(G.tl<=0)clearInterval(G.ti)},1000)}
function sndHt(){if(!aID()||!G.cw)return;const h=[];for(let i=0;i<G.cw.length;i++)if(G.cw[i]!==' '&&!G.hr.includes(i))h.push(i);if(h.length>0){const x=h[Math.floor(Math.random()*h.length)];G.hr.push(x);net.tx({type:'ht',ci:x,ch:G.cw[x]});addC('sys','üí° Letter revealed!')}}
function hHt(m){G.hr.push(m.ci);if(!aID()){const d=$('wDisp'),p=d.textContent.split(' ');if(m.ci<p.length)p[m.ci]=m.ch;d.textContent=p.join(' ');d.classList.add('hn')}addC('sys','üí° Letter revealed!')}
function hET(all){clearInterval(G.ti);if(G.gp.size>0){const dr=G.ps.find(p=>p.id===gDI());if(dr)dr.score+=Math.min(G.gp.size*10,50)}net.tx({type:'te',a:all,w:G.cw,sc:G.ps.map(p=>({...p}))});hTE({a:all,w:G.cw,sc:G.ps.map(p=>({...p}))})}
function hTE(m){clearInterval(G.ti);playTU();$('rResT').textContent=m.a?'üéâ Everyone Guessed!':'‚è∞ Time\'s Up!';$('revW').textContent=m.w||'???';G.ps=m.sc||G.ps;const s=$('rScores');s.innerHTML='';G.ps.forEach(p=>{const d=document.createElement('div');d.className='si';d.innerHTML=`<span class="sn">${p.avatar} ${p.name}</span><span class="sp">${p.score} pts</span>`;s.appendChild(d)});$('rResOv').classList.add('act');renderP();setTimeout(()=>{$('rResOv').classList.remove('act');if(R.hid===myId)advT()},3500)}
function advT(){G.idx++;if(G.idx>=G.to.length){G.idx=0;G.rn++;if(G.rn>G.tr){hGOv();return}G.to.sort(()=>Math.random()-.5)}hST()}
function hGOv(){const s=[...G.ps].sort((a,b)=>b.score-a.score);net.tx({type:'go',ps:s});hGO({ps:s})}
function hGO(m){G.ph='over';clearInterval(G.ti);const s=m.ps;$('winN').textContent=s[0].name+' '+s[0].avatar;const c=$('fScores');c.innerHTML='';const rl=['g','s','b'],re=['ü•á','ü•à','ü•â'];s.forEach((p,i)=>{const d=document.createElement('div');d.className='fi'+(i===0?' f1':'');d.innerHTML=`<div class="fr ${rl[i]||''}">${i<3?re[i]:'#'+(i+1)}</div><div class="fn">${p.avatar} ${p.name}</div><div class="fp">${p.score}</div>`;c.appendChild(d)});$('goOv').classList.add('act');stopV()}
function backLobby(){$('goOv').classList.remove('act');clearInterval(G.ti);G.ph='lobby';stopV();G.ps.forEach(p=>p.score=0);R.ps=G.ps;renderW();ss('waitingScreen')}

function remoteGs(m){if(m.pi!==myId)addC('pm',m.g,m.pn,m.v);if(aID()&&G.cw){const n=m.g.toLowerCase().trim(),w=G.cw.toLowerCase().trim();if(n===w&&!G.gp.has(m.pi)){G.gp.add(m.pi);const pt=Math.max(10,60-Math.floor((G.dt-G.tl)/G.dt*50));const p=G.ps.find(x=>x.id===m.pi);if(p)p.score+=pt;playOk();net.tx({type:'gc',pi:m.pi,pn:m.pn,pt,sc:G.ps.map(x=>({...x}))});addC('cor',`üéâ ${m.pn} guessed it! (+${pt})`);renderP()}else if(isCl(n,w)){net.tx({type:'cg',t:`'${m.g}' is close!`});addC('cl',`'${m.g}' is close!`)}}}
function isCl(g,w){if(g.length<3||w.length<3)return false;if(w.includes(g)||g.includes(w))return true;let d=0;const l=Math.max(g.length,w.length);for(let i=0;i<l;i++)if(g[i]!==w[i])d++;return d<=2&&d>0}

// CANVAS
function initCv(){cv=document.getElementById('drawCanvas');cx=cv.getContext('2d');rsCv();window.addEventListener('resize',rsCv);cv.addEventListener('mousedown',oD);cv.addEventListener('mousemove',oM);cv.addEventListener('mouseup',oU);cv.addEventListener('mouseleave',oU);cv.addEventListener('touchstart',e=>{e.preventDefault();oD(tE(e))},{passive:false});cv.addEventListener('touchmove',e=>{e.preventDefault();oM(tE(e))},{passive:false});cv.addEventListener('touchend',e=>{e.preventDefault();oU()},{passive:false});cx.fillStyle='#fff';cx.fillRect(0,0,cv.width,cv.height);dh=[];svH()}
function rsCv(){const w=document.querySelector('.cw');if(!w)return;const mW=w.clientWidth-16,mH=w.clientHeight-16,r=780/520;let cw=mW,ch=cw/r;if(ch>mH){ch=mH;cw=ch*r}cv.style.width=cw+'px';cv.style.height=ch+'px'}
function tE(e){const r=cv.getBoundingClientRect(),t=e.touches[0];return{offsetX:(t.clientX-r.left)/r.width*cv.width,offsetY:(t.clientY-r.top)/r.height*cv.height}}
function gP(e){const r=cv.getBoundingClientRect();return e.offsetX!==undefined&&e.target===cv?{x:e.offsetX/r.width*cv.width,y:e.offsetY/r.height*cv.height}:{x:e.offsetX,y:e.offsetY}}
function oD(e){if(!aID())return;dw=true;const p=gP(e);if(ct==='fill'){fFill(Math.round(p.x),Math.round(p.y),cc);svH();net.tx({type:'dd',a:'f',d:{x:Math.round(p.x),y:Math.round(p.y),c:cc}});return}sd=[{x:p.x,y:p.y}];cx.beginPath();cx.moveTo(p.x,p.y)}
function oM(e){if(!dw||!aID()||ct==='fill')return;const p=gP(e);sd.push({x:p.x,y:p.y});cx.lineWidth=cs;cx.lineCap='round';cx.lineJoin='round';cx.strokeStyle=ct==='eraser'?'#fff':cc;cx.lineTo(p.x,p.y);cx.stroke();cx.beginPath();cx.moveTo(p.x,p.y)}
function oU(){if(!dw)return;dw=false;if(sd.length>0){svH();net.tx({type:'dd',a:'s',d:{p:sd,c:ct==='eraser'?'#FFFFFF':cc,s:cs}});sd=[]}}
function svH(){if(!cx)return;dh.push(cx.getImageData(0,0,cv.width,cv.height));if(dh.length>30)dh.shift()}
function undo(){if(!aID())return;if(dh.length>1){dh.pop();cx.putImageData(dh[dh.length-1],0,0);net.tx({type:'dd',a:'u',d:cv.toDataURL('image/png',0.4)})}else{cx.fillStyle='#fff';cx.fillRect(0,0,cv.width,cv.height);net.tx({type:'dd',a:'c'})}}
function clr(){if(!aID())return;cx.fillStyle='#fff';cx.fillRect(0,0,cv.width,cv.height);dh=[];svH();net.tx({type:'dd',a:'c'})}
function rpS(d){if(!cx)return;cx.beginPath();cx.strokeStyle=d.c;cx.lineWidth=d.s;cx.lineCap='round';cx.lineJoin='round';if(d.p.length>0){cx.moveTo(d.p[0].x,d.p[0].y);for(let i=1;i<d.p.length;i++)cx.lineTo(d.p[i].x,d.p[i].y);cx.stroke()}}
function rpF(d){fFill(d.x,d.y,d.c)}function rpU(u){const img=new Image();img.onload=()=>{cx.drawImage(img,0,0)};img.src=u}
function fFill(sx,sy,fc){if(!cx)return;const id=cx.getImageData(0,0,cv.width,cv.height),d=id.data,w=cv.width,h=cv.height,st=[[sx,sy]],hex=fc.replace('#',''),fr=parseInt(hex.substr(0,2),16),fg=parseInt(hex.substr(2,2),16),fb=parseInt(hex.substr(4,2),16),ix=(sy*w+sx)*4,tr=d[ix],tg=d[ix+1],tb=d[ix+2];if(fr===tr&&fg===tg&&fb===tb)return;const mt=i=>d[i]===tr&&d[i+1]===tg&&d[i+2]===tb;while(st.length>0){const[x,y]=st.pop();if(x<0||x>=w||y<0||y>=h)continue;const i=(y*w+x)*4;if(!mt(i))continue;d[i]=fr;d[i+1]=fg;d[i+2]=fb;d[i+3]=255;st.push([x+1,y],[x-1,y],[x,y+1],[x,y-1])}cx.putImageData(id,0,0)}
function initTb(){const p=$('colPal');p.innerHTML='';COLS.forEach(c=>{const b=document.createElement('div');b.className='cb'+(c==='#000000'?' sel':'');b.style.background=c;if(c==='#FFFFFF')b.style.border='2px solid #555';b.onclick=()=>{p.querySelectorAll('.cb').forEach(x=>x.classList.remove('sel'));b.classList.add('sel');cc=c;setT('pencil')};p.appendChild(b)});const s=$('brSz');s.innerHTML='';BSZ.forEach((b,i)=>{const d=document.createElement('div');d.className='bsb'+(i===1?' sel':'');d.style.width=(b.d+10)+'px';d.style.height=(b.d+10)+'px';const dot=document.createElement('div');dot.className='dot';dot.style.width=b.d+'px';dot.style.height=b.d+'px';d.appendChild(dot);d.onclick=()=>{s.querySelectorAll('.bsb').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');cs=b.s};s.appendChild(d)});setT('pencil')}
function setT(t){ct=t;$('bPen').classList.toggle('sel',t==='pencil');$('bEra').classList.toggle('sel',t==='eraser');$('bFil').classList.toggle('sel',t==='fill')}
function renderP(){const l=$('pList');if(!l)return;const s=G.ps.map(p=>({...p})).sort((a,b)=>b.score-a.score);l.innerHTML='';s.forEach((p,r)=>{const d=document.createElement('div');d.className='pcard'+(gDI()===p.id?' dr':'')+(G.gp.has(p.id)?' gu':'')+(G.sp.has(p.id)?' sp':'');d.innerHTML=`<div class="pr">#${r+1}</div><div class="pav">${p.avatar}</div><div class="pi"><div class="pn">${p.name}${p.id===myId?' (You)':''}</div><div class="ps">${p.score} pts</div></div>${gDI()===p.id?'<div class="di">üé®</div>':''}${G.gp.has(p.id)?'<div class="di">‚úÖ</div>':''}${G.sp.has(p.id)?'<div class="vi">üéôÔ∏è</div>':''}`;l.appendChild(d)})}
function addC(t,x,a,v=false){const c=$('chatMsgs');if(!c)return;const d=document.createElement('div');d.className='cm '+t+(v?' vm':'');if(t==='pm'){const vb=v?'<span class="vbdg">VOICE</span>':'';d.innerHTML=`<span class="ma" style="color:${pCol(a||'')}">${a||''}${vb}:</span> ${esc(x)}`}else d.textContent=x;c.appendChild(d);c.scrollTop=c.scrollHeight}
function pCol(n){const c=['#60a5fa','#f472b6','#4ade80','#fbbf24','#a78bfa','#fb923c','#22d3ee','#f87171'];let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return c[Math.abs(h)%c.length]}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function swTab(t){$('tChat').classList.toggle('act',t==='chat');$('tVoice').classList.toggle('act',t==='voice');$('chatP').classList.toggle('hid',t!=='chat');$('voiceP').classList.toggle('act',t==='voice')}
function playBp(f,d){if(!G.snd)return;try{const a=new(window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.frequency.value=f;g.gain.value=0.1;o.start();g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);o.stop(a.currentTime+d)}catch(e){}}
function playOk(){playBp(880,.15);setTimeout(()=>playBp(1100,.2),150)}function playTk(){playBp(600,.05)}function playTU(){playBp(300,.4)}
function togSnd(){G.snd=!G.snd;document.querySelector('.tbr .bi').textContent=G.snd?'üîä':'üîá'}

// VOICE
function initVz(){const v=$('vViz');if(!v)return;v.innerHTML='';for(let i=0;i<V.vb;i++){const b=document.createElement('div');b.className='vzb';b.style.height='3px';v.appendChild(b)}}
function renderVM(){const c=$('vMems');if(!c)return;c.innerHTML='';G.ps.forEach(p=>{const s=G.sp.has(p.id);const d=document.createElement('div');d.className='vm'+(s?' sa':'');d.innerHTML=`<div class="vma">${p.avatar}<div class="vrg"></div></div><div class="vmi"><div class="vmn">${p.name}${p.id===myId?' (You)':''}</div><div class="vms">${s?'üéôÔ∏è Speaking...':(p.id===myId&&V.on?'üéôÔ∏è Mic on':'In room')}</div></div>`;c.appendChild(d)})}
function togMic(){V.on?stopV():startV()}
async function startV(){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){addC('sys','‚ö†Ô∏è Use Chrome for voice!');return}try{V.ms=await navigator.mediaDevices.getUserMedia({audio:true});V.ac=new(window.AudioContext||window.webkitAudioContext)();const s=V.ac.createMediaStreamSource(V.ms);V.an=V.ac.createAnalyser();V.an.fftSize=64;s.connect(V.an);V.rec=new SR();V.rec.continuous=true;V.rec.interimResults=true;V.rec.lang='en-US';V.rec.onresult=e=>{let it='',fn='';for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)fn+=t;else it+=t}const te=$('vTr');if(it){te.textContent=`üéôÔ∏è "${it}"`;te.classList.add('act');net.tx({type:'sk',pi:myId,o:true})}if(fn){const g=fn.trim();te.textContent=`‚úÖ "${g}"`;te.classList.add('act');setTimeout(()=>{te.classList.remove('act');te.textContent='Listening...'},2000);net.tx({type:'sk',pi:myId,o:false});if(g&&!aID()&&!G.gp.has(myId)){net.tx({type:'gs',pi:myId,pn:myName,g,v:true});addC('pm',g,myName,true)}}};V.rec.onerror=()=>{};V.rec.onend=()=>{if(V.on&&V.mode==='toggle')try{V.rec.start()}catch(e){}};V.cn=true;V.on=true;if(V.mode==='toggle')V.rec.start();uVUI();stVA();addC('sys','üéôÔ∏è Voice connected!');$('vsDot').classList.add('cn');$('vsTxt').textContent='Connected'}catch(e){addC('sys','‚ö†Ô∏è Mic denied.');$('vsDot').className='vsd error'}}
function startLs(){if(!V.rec||!V.cn)return;try{V.rec.start();V.on=true;uVUI()}catch(e){}}
function stopLs(){if(!V.rec)return;try{V.rec.stop();if(V.mode==='ptt'){V.on=false;uVUI()}}catch(e){}}
function stopV(){if(V.rec)try{V.rec.stop()}catch(e){}V.rec=null;if(V.ms){V.ms.getTracks().forEach(t=>t.stop());V.ms=null}if(V.ac){V.ac.close();V.ac=null}if(V.vf){cancelAnimationFrame(V.vf);V.vf=null}V.on=false;V.cn=false;V.an=null;uVUI();$('vsDot').className='vsd';$('vsTxt').textContent='Disconnected';const t=$('vTr');if(t){t.textContent='Press mic to start';t.classList.remove('act')}renderVM();rsVB()}
function uVUI(){const b=$('bMic'),l=$('micLbl');if(!b)return;if(V.on){b.classList.add('ma','li');l.textContent=V.mode==='ptt'?'Talking...':'Listening...'}else if(V.cn){b.classList.add('ma');b.classList.remove('li');l.textContent=V.mode==='ptt'?'Hold Space':'Mic On'}else{b.classList.remove('ma','li');l.textContent='Start Mic'}$('vHn').textContent=V.cn?(V.mode==='ptt'?'Hold SPACE to talk':'Speak ‚Äî auto-submitted!'):'Speak guesses ‚Äî auto-submits!'}
function togVM(m){V.mode=m;$('mTog').classList.toggle('act',m==='toggle');$('mPTT').classList.toggle('act',m==='ptt');if(V.cn){if(m==='toggle')try{V.rec.start();V.on=true}catch(e){}else try{V.rec.stop();V.on=false}catch(e){}uVUI()}}
function togMut(){V.muted=!V.muted;$('bMut').textContent=V.muted?'üîá':'üîà';$('bMut').classList.toggle('act',V.muted)}
function stVA(){if(!V.an)return;const bars=document.querySelectorAll('#vViz .vzb'),bl=V.an.frequencyBinCount,da=new Uint8Array(bl);function a(){if(!V.an)return;V.vf=requestAnimationFrame(a);V.an.getByteFrequencyData(da);const st=Math.floor(bl/bars.length);for(let i=0;i<bars.length;i++){const v=da[i*st]||0,h=Math.max(3,(v/255)*36);bars[i].style.height=h+'px';bars[i].style.background=v/255>.3?`hsl(${260+(v/255)*40},80%,${50+(v/255)*20}%)`:'var(--brd)'}}a()}
function rsVB(){document.querySelectorAll('#vViz .vzb').forEach(b=>{b.style.height='3px';b.style.background='var(--brd)'})}

document.addEventListener('DOMContentLoaded',()=>{initAv();initVz();
$('chatIn').addEventListener('keydown',e=>{if(e.key==='Enter'){const i=e.target,g=i.value.trim();if(!g)return;i.value='';if(aID()||G.gp.has(myId))return;net.tx({type:'gs',pi:myId,pn:myName,g,v:false});addC('pm',g,myName,false)}});
document.addEventListener('keydown',e=>{if(e.code==='Space'&&V.mode==='ptt'&&V.cn&&!V.ptt){const f=document.activeElement;if(f&&(f.tagName==='INPUT'||f.tagName==='SELECT'))return;e.preventDefault();V.ptt=true;startLs()}});
document.addEventListener('keyup',e=>{if(e.code==='Space'&&V.mode==='ptt'&&V.ptt){e.preventDefault();V.ptt=false;stopLs()}})});
window.addEventListener('beforeunload',()=>{net.tx({type:'pl',pi:myId,pn:myName})});
</script>
</body>
</html>
