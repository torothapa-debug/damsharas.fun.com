<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DAMSHARAS GAME - Free Multiplayer Drawing & Guessing Game</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-primary: #0b0d17;
  --bg-secondary: #151829;
  --bg-card: #1c2038;
  --bg-input: #252a45;
  --accent-yellow: #ffd23f;
  --accent-green: #4ade80;
  --accent-blue: #60a5fa;
  --accent-pink: #f472b6;
  --accent-purple: #a78bfa;
  --accent-orange: #fb923c;
  --accent-red: #f87171;
  --text-primary: #e8eaf6;
  --text-secondary: #9ca3c4;
  --text-muted: #6b7194;
  --border: #2d3260;
  --correct-green: #22c55e;
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: 
    radial-gradient(ellipse at 20% 50%, rgba(168,139,250,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(96,165,250,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(244,114,182,0.05) 0%, transparent 50%);
  z-index: 0;
  pointer-events: none;
}

/* ===== LOBBY SCREEN ===== */
#lobby {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  position: relative;
  z-index: 1;
  padding: 20px;
}

.logo-container {
  text-align: center;
  margin-bottom: 40px;
  animation: floatIn 0.8s ease-out;
}

@keyframes floatIn {
  from { opacity: 0; transform: translateY(-30px); }
  to { opacity: 1; transform: translateY(0); }
}

.logo-title {
  font-family: 'Fredoka One', cursive;
  font-size: 56px;
  background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange), var(--accent-pink), var(--accent-purple));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: none;
  filter: drop-shadow(0 4px 8px rgba(255,210,63,0.3));
  letter-spacing: 2px;
}

.logo-subtitle {
  font-size: 16px;
  color: var(--text-secondary);
  margin-top: 6px;
  letter-spacing: 3px;
  text-transform: uppercase;
}

.lobby-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 40px;
  width: 100%;
  max-width: 440px;
  box-shadow: var(--shadow);
  animation: floatIn 0.8s ease-out 0.2s both;
}

.lobby-card h2 {
  font-family: 'Fredoka One', cursive;
  font-size: 22px;
  color: var(--accent-yellow);
  margin-bottom: 24px;
  text-align: center;
}

.input-group { margin-bottom: 18px; }

.input-group label {
  display: block;
  font-weight: 700;
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.input-group input, .input-group select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  background: var(--bg-input);
  color: var(--text-primary);
  font-family: 'Nunito', sans-serif;
  font-size: 15px;
  font-weight: 600;
  transition: border-color 0.3s;
  outline: none;
}

.input-group input:focus, .input-group select:focus { border-color: var(--accent-yellow); }
.input-group select option { background: var(--bg-card); }

.avatar-selection {
  display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;
}

.avatar-option {
  width: 48px; height: 48px; border-radius: 50%; border: 3px solid var(--border);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 22px; transition: all 0.2s; background: var(--bg-input);
}
.avatar-option:hover { transform: scale(1.15); }
.avatar-option.selected { border-color: var(--accent-yellow); box-shadow: 0 0 12px rgba(255,210,63,0.4); }

.btn-play {
  width: 100%; padding: 16px; border: none; border-radius: 14px;
  font-family: 'Fredoka One', cursive; font-size: 22px; cursor: pointer;
  transition: all 0.3s;
  background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange));
  color: #1a1a2e; box-shadow: 0 4px 20px rgba(255,210,63,0.3);
}
.btn-play:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(255,210,63,0.45); }

.settings-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

/* ===== GAME SCREEN ===== */
#game { display: none; height: 100vh; position: relative; z-index: 1; }

.top-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 20px; background: var(--bg-secondary);
  border-bottom: 1px solid var(--border); height: 60px;
}
.top-bar-left { display: flex; align-items: center; gap: 16px; }
.game-logo {
  font-family: 'Fredoka One', cursive; font-size: 24px;
  background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange));
  -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
}
.round-info { font-weight: 700; color: var(--text-secondary); font-size: 14px; }
.round-info span { color: var(--accent-blue); }
.top-bar-center { display: flex; align-items: center; gap: 14px; }
.timer-circle {
  width: 44px; height: 44px; border-radius: 50%; border: 3px solid var(--accent-blue);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Fredoka One', cursive; font-size: 18px; color: var(--accent-blue); transition: all 0.3s;
}
.timer-circle.warning { border-color: var(--accent-orange); color: var(--accent-orange); }
.timer-circle.danger { border-color: var(--accent-red); color: var(--accent-red); animation: pulse 0.5s infinite; }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }
.word-display {
  font-family: 'Fredoka One', cursive; font-size: 28px; letter-spacing: 6px;
  color: var(--text-primary); min-width: 200px; text-align: center;
}
.word-display.hint { color: var(--accent-yellow); }
.top-bar-right { display: flex; align-items: center; gap: 10px; }
.btn-icon {
  width: 38px; height: 38px; border-radius: 10px; border: 1px solid var(--border);
  background: var(--bg-card); color: var(--text-secondary); cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s;
}
.btn-icon:hover { border-color: var(--accent-yellow); color: var(--accent-yellow); }

.game-main { display: grid; grid-template-columns: 220px 1fr 300px; height: calc(100vh - 60px); }

/* Players Panel */
.players-panel { background: var(--bg-secondary); border-right: 1px solid var(--border); overflow-y: auto; padding: 10px; }
.player-card {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 12px;
  margin-bottom: 6px; background: var(--bg-card); border: 1px solid transparent; transition: all 0.3s; position: relative;
}
.player-card.drawing { border-color: var(--accent-yellow); background: rgba(255,210,63,0.08); }
.player-card.guessed { border-color: var(--correct-green); background: rgba(34,197,94,0.08); }
.player-card.speaking { border-color: var(--accent-purple); background: rgba(167,139,250,0.1); }
.player-avatar {
  width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-size: 18px; flex-shrink: 0; position: relative;
}
.player-card.speaking .player-avatar::after {
  content: ''; position: absolute; inset: -4px; border-radius: 50%;
  border: 2px solid var(--accent-purple); animation: voiceRing 0.8s ease-out infinite;
}
@keyframes voiceRing { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
.player-info { flex: 1; min-width: 0; }
.player-name { font-weight: 700; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.player-score { font-size: 11px; color: var(--text-muted); font-weight: 600; }
.player-rank { font-family: 'Fredoka One', cursive; font-size: 14px; color: var(--accent-yellow); width: 24px; text-align: center; }
.drawing-indicator { position: absolute; top: 6px; right: 8px; font-size: 14px; animation: bounce 1s infinite; }
.voice-indicator { position: absolute; bottom: 5px; right: 8px; font-size: 11px; color: var(--accent-purple); animation: pulse 0.6s infinite; }
@keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

/* Canvas Area */
.canvas-area { display: flex; flex-direction: column; background: var(--bg-primary); position: relative; }
.canvas-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 10px; position: relative; }
#drawCanvas { background: #ffffff; border-radius: 12px; cursor: crosshair; box-shadow: 0 4px 30px rgba(0,0,0,0.5); max-width: 100%; max-height: 100%; }

.toolbar {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 10px 16px; background: var(--bg-secondary); border-top: 1px solid var(--border); flex-wrap: wrap;
}
.toolbar.disabled { opacity: 0.3; pointer-events: none; }
.color-palette { display: flex; gap: 4px; flex-wrap: wrap; max-width: 320px; }
.color-btn { width: 28px; height: 28px; border-radius: 6px; border: 2px solid transparent; cursor: pointer; transition: all 0.15s; }
.color-btn:hover { transform: scale(1.2); }
.color-btn.selected { border-color: white; box-shadow: 0 0 8px rgba(255,255,255,0.4); transform: scale(1.15); }
.tool-separator { width: 1px; height: 32px; background: var(--border); margin: 0 4px; }
.tool-btn {
  width: 36px; height: 36px; border-radius: 8px; border: 2px solid var(--border);
  background: var(--bg-card); color: var(--text-secondary); cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s;
}
.tool-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
.tool-btn.selected { border-color: var(--accent-yellow); color: var(--accent-yellow); background: rgba(255,210,63,0.1); }
.brush-sizes { display: flex; gap: 6px; align-items: center; }
.brush-size-btn {
  border-radius: 50%; border: 2px solid var(--border); background: var(--bg-card);
  cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
.brush-size-btn .dot { border-radius: 50%; background: var(--text-secondary); }
.brush-size-btn:hover { border-color: var(--accent-blue); }
.brush-size-btn.selected { border-color: var(--accent-yellow); }
.brush-size-btn.selected .dot { background: var(--accent-yellow); }

/* ===== RIGHT PANEL ===== */
.right-panel { display: flex; flex-direction: column; border-left: 1px solid var(--border); background: var(--bg-secondary); }
.panel-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-card); }
.panel-tab {
  flex: 1; padding: 12px 10px; text-align: center; font-weight: 800; font-size: 13px;
  color: var(--text-muted); cursor: pointer; transition: all 0.2s; text-transform: uppercase;
  letter-spacing: 1px; border-bottom: 3px solid transparent; user-select: none;
}
.panel-tab:hover { color: var(--text-secondary); }
.panel-tab.active { color: var(--accent-yellow); border-bottom-color: var(--accent-yellow); }

.chat-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.chat-panel.hidden { display: none; }
.chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 4px; }
.chat-msg { padding: 6px 12px; border-radius: 10px; font-size: 13px; animation: msgIn 0.2s ease-out; word-break: break-word; }
@keyframes msgIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.chat-msg.system { color: var(--text-muted); font-style: italic; text-align: center; font-size: 12px; }
.chat-msg.correct { background: rgba(34,197,94,0.12); color: var(--correct-green); font-weight: 700; text-align: center; border: 1px solid rgba(34,197,94,0.2); }
.chat-msg.player-msg { background: var(--bg-card); }
.chat-msg.player-msg .msg-author { font-weight: 800; margin-right: 6px; }
.chat-msg.close-guess { background: rgba(251,146,60,0.12); color: var(--accent-orange); font-weight: 600; text-align: center; }
.chat-msg.voice-msg { border-left: 3px solid var(--accent-purple); }
.voice-badge {
  display: inline-block; background: var(--accent-purple); color: #fff; font-size: 9px;
  font-weight: 800; padding: 1px 5px; border-radius: 4px; margin-left: 6px; vertical-align: middle;
}
.chat-input-area { padding: 10px; border-top: 1px solid var(--border); }
.chat-input-area input {
  width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 12px;
  background: var(--bg-input); color: var(--text-primary); font-family: 'Nunito', sans-serif;
  font-size: 14px; font-weight: 600; outline: none; transition: border-color 0.3s;
}
.chat-input-area input:focus { border-color: var(--accent-blue); }
.chat-input-area input:disabled { opacity: 0.4; }

/* ===== VOICE PANEL ===== */
.voice-panel { flex: 1; display: none; flex-direction: column; overflow: hidden; }
.voice-panel.active { display: flex; }
.voice-status-bar {
  padding: 10px 14px; display: flex; align-items: center; gap: 8px;
  border-bottom: 1px solid var(--border); font-size: 12px; color: var(--text-secondary);
}
.voice-status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); flex-shrink: 0; }
.voice-status-dot.connected { background: var(--accent-green); box-shadow: 0 0 6px rgba(74,222,128,0.5); }
.voice-status-dot.error { background: var(--accent-red); }
.voice-members { flex: 1; overflow-y: auto; padding: 10px; }
.voice-member {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 12px;
  margin-bottom: 6px; background: var(--bg-card); border: 1px solid transparent; transition: all 0.3s;
}
.voice-member.speaking-active { border-color: var(--accent-purple); background: rgba(167,139,250,0.08); }
.voice-member-avatar {
  width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-size: 17px; position: relative;
}
.voice-member-avatar .voice-ring {
  display: none; position: absolute; inset: -3px; border-radius: 50%; border: 2px solid var(--accent-purple);
}
.voice-member.speaking-active .voice-ring { display: block; animation: voiceRing 0.8s ease-out infinite; }
.voice-member-info { flex: 1; }
.voice-member-name { font-weight: 700; font-size: 13px; }
.voice-member-status { font-size: 11px; color: var(--text-muted); }
.voice-member-volume { width: 50px; height: 20px; display: flex; gap: 2px; align-items: flex-end; }
.vol-bar { flex: 1; background: var(--border); border-radius: 2px; height: 30%; transition: height 0.1s, background 0.1s; }
.vol-bar.active { background: var(--accent-purple); }

.voice-controls { padding: 14px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
.voice-visualizer { height: 40px; display: flex; align-items: flex-end; justify-content: center; gap: 2px; padding: 4px 0; }
.viz-bar { width: 4px; background: var(--accent-purple); border-radius: 2px; transition: height 0.08s ease; min-height: 3px; }
.voice-btns { display: flex; gap: 8px; align-items: center; }
.btn-voice {
  flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 12px;
  background: var(--bg-card); color: var(--text-primary); font-family: 'Nunito', sans-serif;
  font-weight: 700; font-size: 13px; cursor: pointer; transition: all 0.25s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.btn-voice:hover { border-color: var(--accent-purple); }
.btn-voice.mic-active { border-color: var(--accent-purple); background: rgba(167,139,250,0.15); color: var(--accent-purple); box-shadow: 0 0 16px rgba(167,139,250,0.2); }
.btn-voice.mic-active.listening { animation: micPulse 1.5s ease-in-out infinite; }
@keyframes micPulse { 0%,100% { box-shadow: 0 0 16px rgba(167,139,250,0.2); } 50% { box-shadow: 0 0 28px rgba(167,139,250,0.45); } }
.btn-voice-small {
  width: 42px; height: 42px; border: 2px solid var(--border); border-radius: 10px;
  background: var(--bg-card); color: var(--text-secondary); cursor: pointer;
  display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; flex-shrink: 0;
}
.btn-voice-small:hover { border-color: var(--accent-purple); color: var(--accent-purple); }
.btn-voice-small.active { border-color: var(--accent-red); color: var(--accent-red); background: rgba(248,113,113,0.1); }
.voice-mode-toggle { display: flex; gap: 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
.voice-mode-btn {
  flex: 1; padding: 6px 10px; font-size: 11px; font-weight: 700; text-align: center;
  cursor: pointer; background: var(--bg-input); color: var(--text-muted); transition: all 0.2s;
  border: none; text-transform: uppercase; letter-spacing: 0.5px;
}
.voice-mode-btn.active { background: var(--accent-purple); color: #fff; }
.voice-transcript {
  font-size: 12px; color: var(--text-muted); text-align: center; min-height: 18px;
  font-style: italic; padding: 0 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.voice-transcript.active { color: var(--accent-purple); font-style: normal; }
.voice-hint { font-size: 11px; color: var(--text-muted); text-align: center; padding: 4px 0 0; }

/* ===== OVERLAYS ===== */
.overlay {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(11,13,23,0.85); backdrop-filter: blur(8px); z-index: 100;
  align-items: center; justify-content: center;
}
.overlay.active { display: flex; }
.word-selection {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px;
  padding: 40px; text-align: center; box-shadow: var(--shadow);
  animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}
@keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.word-selection h2 { font-family: 'Fredoka One', cursive; font-size: 24px; color: var(--accent-yellow); margin-bottom: 24px; }
.word-options { display: flex; gap: 14px; }
.word-option {
  padding: 16px 32px; border: 2px solid var(--border); border-radius: 14px;
  background: var(--bg-input); color: var(--text-primary);
  font-family: 'Fredoka One', cursive; font-size: 18px; cursor: pointer; transition: all 0.3s;
}
.word-option:hover { border-color: var(--accent-yellow); background: rgba(255,210,63,0.1); transform: translateY(-4px); box-shadow: 0 8px 24px rgba(255,210,63,0.2); }

.results-panel {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px;
  padding: 40px; text-align: center; box-shadow: var(--shadow);
  animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); min-width: 400px;
}
.results-panel h2 { font-family: 'Fredoka One', cursive; font-size: 28px; margin-bottom: 8px; }
.results-panel .word-reveal { font-size: 16px; color: var(--text-secondary); margin-bottom: 24px; }
.results-panel .word-reveal span { color: var(--accent-yellow); font-weight: 800; }
.score-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
.score-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; background: var(--bg-input); border-radius: 10px; }
.score-item .name { font-weight: 700; }
.score-item .points { color: var(--accent-green); font-weight: 800; }
.score-item .points.zero { color: var(--text-muted); }

.game-over-panel {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px;
  padding: 50px; text-align: center; box-shadow: var(--shadow);
  animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); min-width: 450px;
}
.game-over-panel h1 {
  font-family: 'Fredoka One', cursive; font-size: 36px;
  background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange));
  -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;
}
.winner-info { font-size: 18px; color: var(--text-secondary); margin-bottom: 30px; }
.winner-info .winner-name { color: var(--accent-yellow); font-weight: 800; font-size: 22px; }
.final-scores { display: flex; flex-direction: column; gap: 8px; margin-bottom: 30px; }
.final-score-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-input); border-radius: 12px; }
.final-score-item.first { border: 2px solid var(--accent-yellow); background: rgba(255,210,63,0.08); }
.final-rank { font-family: 'Fredoka One', cursive; font-size: 18px; width: 30px; }
.final-rank.gold { color: var(--accent-yellow); }
.final-rank.silver { color: #c0c0c0; }
.final-rank.bronze { color: #cd7f32; }
.final-name { flex: 1; text-align: left; font-weight: 700; }
.final-points { font-family: 'Fredoka One', cursive; color: var(--accent-green); font-size: 18px; }
.btn-play-again {
  padding: 14px 40px; border: none; border-radius: 14px;
  font-family: 'Fredoka One', cursive; font-size: 20px; cursor: pointer;
  background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange));
  color: #1a1a2e; box-shadow: 0 4px 20px rgba(255,210,63,0.3); transition: all 0.3s;
}
.btn-play-again:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(255,210,63,0.45); }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

@media (max-width: 900px) {
  .game-main { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
  .players-panel { display: flex; overflow-x: auto; border-right: none; border-bottom: 1px solid var(--border); padding: 6px; gap: 6px; }
  .player-card { min-width: 130px; margin-bottom: 0; }
  .right-panel { max-height: 260px; }
  .logo-title { font-size: 36px; }
}
</style>
</head>
<body>

<!-- LOBBY -->
<div id="lobby">
  <div class="logo-container">
    <div class="logo-title">DAMSHARAS</div>
    <div class="logo-subtitle">Drawing & Guessing Game</div>
  </div>
  <div class="lobby-card">
    <h2>üé® Join Game</h2>
    <div class="input-group"><label>Your Name</label><input type="text" id="playerName" placeholder="Enter your name..." maxlength="16"></div>
    <div class="input-group"><label>Choose Avatar</label><div class="avatar-selection" id="avatarSelection"></div></div>
    <div class="settings-row">
      <div class="input-group"><label>Rounds</label><select id="roundsSelect"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div>
      <div class="input-group"><label>Draw Time</label><select id="drawTimeSelect"><option value="40">40s</option><option value="60">60s</option><option value="80" selected>80s</option><option value="100">100s</option><option value="120">120s</option></select></div>
    </div>
    <div class="settings-row">
      <div class="input-group"><label>Players (Bots)</label><select id="botCountSelect"><option value="3">3</option><option value="5" selected>5</option><option value="7">7</option><option value="9">9</option></select></div>
      <div class="input-group"><label>Bot Voices</label><select id="botVoicesSelect"><option value="on" selected>Enabled</option><option value="off">Disabled</option></select></div>
    </div>
    <button class="btn-play" onclick="startGame()">üéÆ PLAY!</button>
  </div>
</div>

<!-- GAME -->
<div id="game">
  <div class="top-bar">
    <div class="top-bar-left"><div class="game-logo">DAMSHARAS</div><div class="round-info">Round <span id="roundNum">1</span> of <span id="totalRounds">3</span></div></div>
    <div class="top-bar-center"><div class="timer-circle" id="timer">80</div><div class="word-display" id="wordDisplay">_ _ _ _ _</div></div>
    <div class="top-bar-right"><button class="btn-icon" onclick="toggleSound()" title="Toggle sound">üîä</button></div>
  </div>
  <div class="game-main">
    <div class="players-panel" id="playersList"></div>
    <div class="canvas-area">
      <div class="canvas-wrapper"><canvas id="drawCanvas" width="780" height="520"></canvas></div>
      <div class="toolbar" id="toolbar">
        <div class="color-palette" id="colorPalette"></div><div class="tool-separator"></div>
        <div class="brush-sizes" id="brushSizes"></div><div class="tool-separator"></div>
        <button class="tool-btn" id="btnPencil" title="Pencil" onclick="setTool('pencil')">‚úèÔ∏è</button>
        <button class="tool-btn" id="btnEraser" title="Eraser" onclick="setTool('eraser')">üßπ</button>
        <button class="tool-btn" id="btnFill" title="Fill" onclick="setTool('fill')">ü™£</button>
        <button class="tool-btn" id="btnUndo" title="Undo" onclick="undoDraw()">‚Ü©Ô∏è</button>
        <button class="tool-btn" id="btnClear" title="Clear" onclick="clearCanvas()">üóëÔ∏è</button>
      </div>
    </div>
    <div class="right-panel">
      <div class="panel-tabs">
        <div class="panel-tab active" id="tabChat" onclick="switchTab('chat')">üí¨ Chat</div>
        <div class="panel-tab" id="tabVoice" onclick="switchTab('voice')">üéôÔ∏è Voice</div>
      </div>
      <div class="chat-panel" id="chatPanelContent">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area"><input type="text" id="chatInput" placeholder="Type your guess here..." maxlength="50" autocomplete="off"></div>
      </div>
      <div class="voice-panel" id="voicePanelContent">
        <div class="voice-status-bar"><div class="voice-status-dot" id="voiceStatusDot"></div><span id="voiceStatusText">Voice chat disconnected</span></div>
        <div class="voice-members" id="voiceMembers"></div>
        <div class="voice-controls">
          <div class="voice-visualizer" id="voiceVisualizer"></div>
          <div class="voice-transcript" id="voiceTranscript">Press mic to start speaking</div>
          <div class="voice-mode-toggle">
            <button class="voice-mode-btn active" id="modeToggle" onclick="toggleVoiceMode('toggle')">Toggle</button>
            <button class="voice-mode-btn" id="modePTT" onclick="toggleVoiceMode('ptt')">Push to Talk</button>
          </div>
          <div class="voice-btns">
            <button class="btn-voice" id="btnMic" onclick="toggleMic()"><span>üéôÔ∏è</span><span id="micBtnLabel">Start Mic</span></button>
            <button class="btn-voice-small" id="btnMute" onclick="toggleMute()" title="Mute speakers">üîà</button>
            <button class="btn-voice-small" id="btnTTS" onclick="toggleTTS()" title="Toggle bot voices">üó£Ô∏è</button>
          </div>
          <div class="voice-hint" id="voiceHint">Speak your guesses ‚Äî voice recognition will submit them!</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OVERLAYS -->
<div class="overlay" id="wordSelectOverlay"><div class="word-selection"><h2>‚ú® Choose a word to draw!</h2><div class="word-options" id="wordOptions"></div></div></div>
<div class="overlay" id="roundResultOverlay"><div class="results-panel"><h2 id="roundResultTitle">‚è∞ Time's Up!</h2><div class="word-reveal">The word was: <span id="revealWord"></span></div><div class="score-list" id="roundScores"></div></div></div>
<div class="overlay" id="gameOverOverlay"><div class="game-over-panel"><h1>üèÜ Game Over!</h1><div class="winner-info">Winner: <span class="winner-name" id="winnerName"></span></div><div class="final-scores" id="finalScores"></div><button class="btn-play-again" onclick="backToLobby()">Play Again</button></div></div>

<script>
const WORDS=["apple","banana","car","dog","elephant","fish","guitar","house","ice cream","jacket","kite","lion","moon","notebook","ocean","pizza","queen","rainbow","sun","tree","umbrella","volcano","whale","xylophone","yacht","zebra","airplane","butterfly","castle","diamond","eagle","flower","ghost","hamburger","island","jellyfish","kangaroo","lighthouse","mountain","necklace","octopus","penguin","robot","snowflake","telescope","unicorn","violin","waterfall","computer","dragon","firework","giraffe","helicopter","igloo","jungle","keyboard","lemon","mushroom","ninja","parachute","sandwich","tornado","wizard","astronaut","bicycle","cactus","dolphin","feather","grapes","hammer","lamp","magnet","orange","pillow","rocket","scissors","trophy","anchor","bridge","candle","drum","envelope","frog","globe","heart","insect","jewel","ladder","mirror","nest","paint","ring","skull","sword","tent","vacuum","window","arrow","battery","cherry","dice","egg","flag","glasses","harp","iron","jar","key","leaf","medal","net","owl","pearl","quilt","rope","snake","tiger","vase","watch","angel","boat","crown","door","earth","forest","garden","horse","iceberg","juice","king","library","marble","nurse","present","star","train","village","waffle","camera","dinosaur","emerald","football","gorilla","headphones","internet","jigsaw","koala","lollipop","mermaid","newspaper","ostrich","pineapple","raccoon","satellite","trampoline","walrus","basketball","caterpillar","dragonfly","escalator","flamingo","grasshopper","harmonica","jackhammer","kaleidoscope","limousine","marshmallow","nightingale","origami","platypus","quicksand","rhinoceros","scarecrow","thunderstorm","watermelon","broccoli","chandelier","dreamcatcher","fireplace","goldfish","hummingbird","chameleon","jellybean","labyrinth","mandolin","nightmare","palmtree","rollercoaster","stopwatch","submarine","sunflower","suitcase","surfboard","treasure","tricycle","trombone","skateboard","spaceship","starfish","strawberry","superhero","toothbrush","triceratops"];
const BOT_NAMES=["ArtBot","Sketchy","DoodleMaster","DrawKing","PicassoAI","PaintPro","InkWizard","BrushBoss","CanvasCat","LineArtist","ColorPop","QuickDraw","PixelPal","NeonNinja","CrayonKid","VividViper","StrokeStar","ShadowPen","GlowGuru","ChalkChamp"];
const AVATARS=["üòÄ","üòé","ü§ì","ü•≥","üò∫","ü¶ä","üê∏","üêµ","üëª","ü§ñ","üëΩ","üéÉ","ü¶Ñ","üêº","üêß","ü¶Å"];
const COLORS=["#000000","#555555","#8B4513","#FF0000","#FF8C00","#FFD700","#008000","#00CED1","#0000FF","#8A2BE2","#FF1493","#FFFFFF","#AAAAAA","#D2691E","#FF6347","#FFA500","#FFFF00","#7CFC00","#00FFFF","#1E90FF","#9370DB","#FF69B4"];
const BRUSH_SIZES=[{size:3,display:6},{size:6,display:10},{size:12,display:16},{size:22,display:22},{size:36,display:28}];

let state={players:[],currentWord:'',round:1,totalRounds:3,drawTime:80,timeLeft:80,timerInterval:null,myIndex:0,guessedPlayers:new Set(),turnOrder:[],turnIndex:0,soundEnabled:true,hintRevealed:[],phase:'lobby',botVoicesEnabled:true,speakingPlayers:new Set()};
let canvas,ctx,drawing=false,currentColor='#000000',currentSize=6,currentTool='pencil',drawHistory=[],currentPath=[];
let voiceChat={recognition:null,isListening:false,mode:'toggle',isMuted:false,ttsEnabled:true,mediaStream:null,audioContext:null,analyser:null,vizBars:24,vizAnimFrame:null,connected:false,pttHeld:false};

// Audio
function playBeep(f,d){if(!state.soundEnabled)return;try{const a=new(window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.frequency.value=f;g.gain.value=0.1;o.start();g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);o.stop(a.currentTime+d)}catch(e){}}
function playCorrect(){playBeep(880,.15);setTimeout(()=>playBeep(1100,.2),150)}
function playTick(){playBeep(600,.05)}
function playTimeUp(){playBeep(300,.4)}
function playVoiceOn(){playBeep(700,.08);setTimeout(()=>playBeep(900,.08),80)}
function playVoiceOff(){playBeep(500,.08);setTimeout(()=>playBeep(400,.08),80)}

// Tabs
function switchTab(t){document.getElementById('tabChat').classList.toggle('active',t==='chat');document.getElementById('tabVoice').classList.toggle('active',t==='voice');document.getElementById('chatPanelContent').classList.toggle('hidden',t!=='chat');document.getElementById('voicePanelContent').classList.toggle('active',t==='voice')}

// Lobby
function initLobby(){const c=document.getElementById('avatarSelection');c.innerHTML='';AVATARS.forEach((a,i)=>{const d=document.createElement('div');d.className='avatar-option'+(i===0?' selected':'');d.textContent=a;d.onclick=()=>{c.querySelectorAll('.avatar-option').forEach(e=>e.classList.remove('selected'));d.classList.add('selected')};c.appendChild(d)});initVoiceVisualizer()}

// Start Game
function startGame(){const name=document.getElementById('playerName').value.trim()||'Player';const avatar=document.querySelector('.avatar-option.selected')?.textContent||'üòÄ';const botCount=parseInt(document.getElementById('botCountSelect').value);state.totalRounds=parseInt(document.getElementById('roundsSelect').value);state.drawTime=parseInt(document.getElementById('drawTimeSelect').value);state.botVoicesEnabled=document.getElementById('botVoicesSelect').value==='on';voiceChat.ttsEnabled=state.botVoicesEnabled;
state.players=[{name,avatar,score:0,isBot:false}];const sb=[...BOT_NAMES].sort(()=>Math.random()-.5);const sa=[...AVATARS].sort(()=>Math.random()-.5);for(let i=0;i<botCount;i++)state.players.push({name:sb[i%sb.length],avatar:sa[(i+3)%sa.length],score:0,isBot:true});
state.turnOrder=state.players.map((_,i)=>i);state.turnOrder.sort(()=>Math.random()-.5);state.turnIndex=0;state.round=1;state.myIndex=0;state.phase='playing';
document.getElementById('lobby').style.display='none';document.getElementById('game').style.display='block';document.getElementById('totalRounds').textContent=state.totalRounds;
initCanvas();initToolbar();renderPlayers();renderVoiceMembers();addChatMessage('system','Welcome to DAMSHARAS! Game starts now.');speakTTS('Welcome to Damsharas! Game starts now.');switchTab('chat');startTurn()}

// Canvas
function initCanvas(){canvas=document.getElementById('drawCanvas');ctx=canvas.getContext('2d');resizeCanvas();window.addEventListener('resize',resizeCanvas);canvas.addEventListener('mousedown',onPointerDown);canvas.addEventListener('mousemove',onPointerMove);canvas.addEventListener('mouseup',onPointerUp);canvas.addEventListener('mouseleave',onPointerUp);canvas.addEventListener('touchstart',e=>{e.preventDefault();onPointerDown(touchToMouse(e))},{passive:false});canvas.addEventListener('touchmove',e=>{e.preventDefault();onPointerMove(touchToMouse(e))},{passive:false});canvas.addEventListener('touchend',e=>{e.preventDefault();onPointerUp()},{passive:false});clearCanvas()}
function resizeCanvas(){const w=document.querySelector('.canvas-wrapper');const mW=w.clientWidth-20,mH=w.clientHeight-20,r=780/520;let cw=mW,ch=cw/r;if(ch>mH){ch=mH;cw=ch*r}canvas.style.width=cw+'px';canvas.style.height=ch+'px'}
function touchToMouse(e){const r=canvas.getBoundingClientRect(),t=e.touches[0];return{offsetX:(t.clientX-r.left)/r.width*canvas.width,offsetY:(t.clientY-r.top)/r.height*canvas.height}}
function getPos(e){const r=canvas.getBoundingClientRect();if(e.offsetX!==undefined&&e.target===canvas)return{x:e.offsetX/r.width*canvas.width,y:e.offsetY/r.height*canvas.height};return{x:e.offsetX,y:e.offsetY}}
function onPointerDown(e){if(!isMyTurn())return;drawing=true;const p=getPos(e);if(currentTool==='fill'){floodFill(Math.round(p.x),Math.round(p.y),currentColor);saveHistory();return}currentPath=[{x:p.x,y:p.y}];ctx.beginPath();ctx.moveTo(p.x,p.y)}
function onPointerMove(e){if(!drawing||!isMyTurn()||currentTool==='fill')return;const p=getPos(e);currentPath.push({x:p.x,y:p.y});ctx.lineWidth=currentSize;ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle=currentTool==='eraser'?'#FFFFFF':currentColor;ctx.lineTo(p.x,p.y);ctx.stroke();ctx.beginPath();ctx.moveTo(p.x,p.y)}
function onPointerUp(){if(!drawing)return;drawing=false;if(currentPath.length>0){saveHistory();currentPath=[]}}
function saveHistory(){const d=ctx.getImageData(0,0,canvas.width,canvas.height);drawHistory.push(d);if(drawHistory.length>30)drawHistory.shift()}
function undoDraw(){if(drawHistory.length>1){drawHistory.pop();ctx.putImageData(drawHistory[drawHistory.length-1],0,0)}else if(drawHistory.length===1){drawHistory.pop();ctx.fillStyle='#FFFFFF';ctx.fillRect(0,0,canvas.width,canvas.height)}}
function clearCanvas(){ctx.fillStyle='#FFFFFF';ctx.fillRect(0,0,canvas.width,canvas.height);drawHistory=[];saveHistory()}
function floodFill(sx,sy,fc){const id=ctx.getImageData(0,0,canvas.width,canvas.height),d=id.data,w=canvas.width,h=canvas.height,st=[[sx,sy]],hex=fc.replace('#',''),fr=parseInt(hex.substr(0,2),16),fg=parseInt(hex.substr(2,2),16),fb=parseInt(hex.substr(4,2),16),idx=(sy*w+sx)*4,tr=d[idx],tg=d[idx+1],tb=d[idx+2];if(fr===tr&&fg===tg&&fb===tb)return;const m=i=>d[i]===tr&&d[i+1]===tg&&d[i+2]===tb;while(st.length>0){const[x,y]=st.pop();if(x<0||x>=w||y<0||y>=h)continue;const i=(y*w+x)*4;if(!m(i))continue;d[i]=fr;d[i+1]=fg;d[i+2]=fb;d[i+3]=255;st.push([x+1,y],[x-1,y],[x,y+1],[x,y-1])}ctx.putImageData(id,0,0)}

// Toolbar
function initToolbar(){const p=document.getElementById('colorPalette');p.innerHTML='';COLORS.forEach(c=>{const b=document.createElement('div');b.className='color-btn'+(c==='#000000'?' selected':'');b.style.background=c;if(c==='#FFFFFF')b.style.border='2px solid #555';b.onclick=()=>{p.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');currentColor=c;setTool('pencil')};p.appendChild(b)});
const s=document.getElementById('brushSizes');s.innerHTML='';BRUSH_SIZES.forEach((bs,i)=>{const b=document.createElement('div');b.className='brush-size-btn'+(i===1?' selected':'');b.style.width=(bs.display+10)+'px';b.style.height=(bs.display+10)+'px';const dot=document.createElement('div');dot.className='dot';dot.style.width=bs.display+'px';dot.style.height=bs.display+'px';b.appendChild(dot);b.onclick=()=>{s.querySelectorAll('.brush-size-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');currentSize=bs.size};s.appendChild(b)});setTool('pencil')}
function setTool(t){currentTool=t;document.getElementById('btnPencil').classList.toggle('selected',t==='pencil');document.getElementById('btnEraser').classList.toggle('selected',t==='eraser');document.getElementById('btnFill').classList.toggle('selected',t==='fill')}

// Players
function renderPlayers(){const l=document.getElementById('playersList'),sorted=state.players.map((p,i)=>({...p,idx:i})).sort((a,b)=>b.score-a.score);l.innerHTML='';sorted.forEach((p,rank)=>{const isD=state.turnOrder[state.turnIndex]===p.idx,hasG=state.guessedPlayers.has(p.idx),isS=state.speakingPlayers.has(p.idx);const c=document.createElement('div');c.className='player-card'+(isD?' drawing':'')+(hasG?' guessed':'')+(isS?' speaking':'');c.innerHTML=`<div class="player-rank">#${rank+1}</div><div class="player-avatar">${p.avatar}</div><div class="player-info"><div class="player-name">${p.name}${p.idx===state.myIndex?' (You)':''}</div><div class="player-score">${p.score} pts</div></div>${isD?'<div class="drawing-indicator">üé®</div>':''}${hasG?'<div class="drawing-indicator">‚úÖ</div>':''}${isS?'<div class="voice-indicator">üéôÔ∏è</div>':''}`;l.appendChild(c)})}

// Chat
function addChatMessage(type,text,author,isVoice=false){const c=document.getElementById('chatMessages'),d=document.createElement('div');d.className='chat-msg '+type+(isVoice?' voice-msg':'');if(type==='player-msg'){const vb=isVoice?'<span class="voice-badge">VOICE</span>':'';d.innerHTML=`<span class="msg-author" style="color:${getPlayerColor(author)}">${author}${vb}:</span> ${escapeHtml(text)}`}else d.textContent=text;c.appendChild(d);c.scrollTop=c.scrollHeight}
function getPlayerColor(n){const cs=['#60a5fa','#f472b6','#4ade80','#fbbf24','#a78bfa','#fb923c','#22d3ee','#f87171'];let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return cs[Math.abs(h)%cs.length]}
function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

document.addEventListener('DOMContentLoaded',()=>{initLobby();
document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){const i=e.target,g=i.value.trim();if(!g)return;i.value='';if(isMyTurn()||state.guessedPlayers.has(state.myIndex))return;handleGuess(state.myIndex,g,false)}});
document.addEventListener('keydown',e=>{if(e.code==='Space'&&voiceChat.mode==='ptt'&&voiceChat.connected&&!voiceChat.pttHeld){if(document.activeElement===document.getElementById('chatInput'))return;e.preventDefault();voiceChat.pttHeld=true;startListening()}});
document.addEventListener('keyup',e=>{if(e.code==='Space'&&voiceChat.mode==='ptt'&&voiceChat.pttHeld){e.preventDefault();voiceChat.pttHeld=false;stopListening()}})});

// Turns
function isMyTurn(){return state.turnOrder[state.turnIndex]===state.myIndex}
function getCurrentDrawerIndex(){return state.turnOrder[state.turnIndex]}

function startTurn(){state.guessedPlayers=new Set();state.hintRevealed=[];state.speakingPlayers=new Set();clearCanvas();drawHistory=[];
const di=getCurrentDrawerIndex(),dr=state.players[di];document.getElementById('roundNum').textContent=state.round;
addChatMessage('system',`${dr.name} is now drawing!`);speakTTS(`${dr.name} is now drawing!`);renderPlayers();renderVoiceMembers();
document.getElementById('toolbar').classList.toggle('disabled',!isMyTurn());document.getElementById('chatInput').disabled=isMyTurn();document.getElementById('chatInput').placeholder=isMyTurn()?'You are drawing!':'Type your guess here...';
if(isMyTurn())showWordSelection();else{state.currentWord=getRandomWords(1)[0];updateWordDisplay();startTimer();simulateBotDrawing(di);scheduleBotGuesses()}}

function showWordSelection(){const ws=getRandomWords(3),c=document.getElementById('wordOptions');c.innerHTML='';ws.forEach(w=>{const b=document.createElement('div');b.className='word-option';b.textContent=w;b.onclick=()=>{state.currentWord=w;document.getElementById('wordSelectOverlay').classList.remove('active');updateWordDisplay(true);startTimer();scheduleBotGuesses()};c.appendChild(b)});document.getElementById('wordSelectOverlay').classList.add('active')}
function getRandomWords(n){return[...WORDS].sort(()=>Math.random()-.5).slice(0,n)}
function updateWordDisplay(full=false){const d=document.getElementById('wordDisplay');if(full&&isMyTurn()){d.textContent=state.currentWord;d.classList.remove('hint')}else{let m='';for(let i=0;i<state.currentWord.length;i++){if(state.currentWord[i]===' ')m+='  ';else if(state.hintRevealed.includes(i))m+=state.currentWord[i];else m+='_';if(i<state.currentWord.length-1)m+=' '}d.textContent=m;d.classList.toggle('hint',state.hintRevealed.length>0)}}

// Timer
function startTimer(){state.timeLeft=state.drawTime;const t=document.getElementById('timer');t.textContent=state.timeLeft;t.className='timer-circle';const h1=Math.floor(state.drawTime*.5),h2=Math.floor(state.drawTime*.25);
clearInterval(state.timerInterval);state.timerInterval=setInterval(()=>{state.timeLeft--;t.textContent=state.timeLeft;
if(state.timeLeft<=10)t.className='timer-circle danger';else if(state.timeLeft<=20)t.className='timer-circle warning';else t.className='timer-circle';
if(state.timeLeft<=5)playTick();if(state.timeLeft===h1||state.timeLeft===h2)revealHint();
const nd=state.players.filter((_,i)=>i!==getCurrentDrawerIndex());if(nd.every((_,i)=>state.guessedPlayers.has(state.players.indexOf(nd[i])))){endTurn(true);return}
if(state.timeLeft<=0)endTurn(false)},1000)}

function revealHint(){const hi=[];for(let i=0;i<state.currentWord.length;i++)if(state.currentWord[i]!==' '&&!state.hintRevealed.includes(i))hi.push(i);if(hi.length>0){state.hintRevealed.push(hi[Math.floor(Math.random()*hi.length)]);if(!isMyTurn())updateWordDisplay();addChatMessage('system','üí° A letter has been revealed!')}}

function endTurn(allGuessed){clearInterval(state.timerInterval);clearTimeout(state.botDrawTimeout);state.botGuessTimeouts?.forEach(t=>clearTimeout(t));state.speakingPlayers.clear();playTimeUp();
const w=state.currentWord;document.getElementById('roundResultTitle').textContent=allGuessed?'üéâ Everyone Guessed It!':"‚è∞ Time's Up!";document.getElementById('revealWord').textContent=w;speakTTS(allGuessed?`Everyone guessed it! The word was ${w}.`:`Time's up! The word was ${w}.`);
const sd=document.getElementById('roundScores');sd.innerHTML='';if(state.guessedPlayers.size>0)state.players[getCurrentDrawerIndex()].score+=Math.min(state.guessedPlayers.size*10,50);
state.players.forEach((p,i)=>{const it=document.createElement('div');it.className='score-item';const rp=state.guessedPlayers.has(i)?'+'+getGuessPoints():(i===getCurrentDrawerIndex()&&state.guessedPlayers.size>0?'+'+Math.min(state.guessedPlayers.size*10,50):'0');it.innerHTML=`<span class="name">${p.avatar} ${p.name}</span><span class="points ${rp==='0'?'zero':''}">${rp} pts</span>`;sd.appendChild(it)});
document.getElementById('roundResultOverlay').classList.add('active');renderPlayers();renderVoiceMembers();
setTimeout(()=>{document.getElementById('roundResultOverlay').classList.remove('active');advanceTurn()},3500)}

function getGuessPoints(){return Math.max(10,50-(state.guessedPlayers.size-1)*10)}

function advanceTurn(){state.turnIndex++;if(state.turnIndex>=state.turnOrder.length){state.turnIndex=0;state.round++;if(state.round>state.totalRounds){showGameOver();return}state.turnOrder.sort(()=>Math.random()-.5);addChatMessage('system',`üîÑ Round ${state.round} starts!`);speakTTS(`Round ${state.round} starts!`)}startTurn()}

// Guessing
function handleGuess(pi,guess,isVoice=false){const p=state.players[pi];if(state.guessedPlayers.has(pi)||pi===getCurrentDrawerIndex())return;const n=guess.toLowerCase().trim(),w=state.currentWord.toLowerCase().trim();
if(n===w){state.guessedPlayers.add(pi);const pts=Math.max(10,60-Math.floor((state.drawTime-state.timeLeft)/state.drawTime*50));p.score+=pts;playCorrect();addChatMessage('correct',`üéâ ${p.name} guessed the word! (+${pts})`);if(p.isBot&&voiceChat.ttsEnabled)speakTTS(`${p.name} guessed it!`,.9+Math.random()*.4);renderPlayers();renderVoiceMembers();if(pi===state.myIndex){document.getElementById('chatInput').disabled=true;document.getElementById('chatInput').placeholder='You guessed it! ‚úÖ'}}
else if(isCloseGuess(n,w)){addChatMessage('close-guess',`'${guess}' is close!`);if(pi===state.myIndex)addChatMessage('player-msg',guess,p.name,isVoice)}
else addChatMessage('player-msg',guess,p.name,isVoice)}

function isCloseGuess(g,w){if(g.length<3||w.length<3)return false;if(w.includes(g)||g.includes(w))return true;let d=0;const l=Math.max(g.length,w.length);for(let i=0;i<l;i++)if(g[i]!==w[i])d++;return d<=2&&d>0}

// Bot behavior
function simulateBotDrawing(di){let step=0;const max=30+Math.floor(Math.random()*30),col=COLORS[Math.floor(Math.random()*12)];function ds(){if(step>=max||state.phase==='gameover')return;ctx.beginPath();ctx.strokeStyle=col;ctx.lineWidth=3+Math.random()*8;ctx.lineCap='round';const cx=100+Math.random()*580,cy=80+Math.random()*360,t=Math.random();if(t<.4){ctx.moveTo(cx,cy);let x=cx,y=cy;for(let i=0;i<5+Math.floor(Math.random()*15);i++){x+=(Math.random()-.5)*60;y+=(Math.random()-.5)*60;ctx.lineTo(x,y)}}else if(t<.7)ctx.arc(cx,cy,20+Math.random()*60,0,Math.PI*2);else{const w=30+Math.random()*100,h=30+Math.random()*80;ctx.rect(cx-w/2,cy-h/2,w,h)}ctx.stroke();step++;state.botDrawTimeout=setTimeout(ds,300+Math.random()*800)}ds()}

function scheduleBotGuesses(){state.botGuessTimeouts=[];const w=state.currentWord;state.players.forEach((p,idx)=>{if(!p.isBot||idx===getCurrentDrawerIndex())return;const wg=Math.random()<.7;if(!wg&&Math.random()<.5)return;const gt=5000+Math.random()*(state.drawTime*700);
const wc=Math.floor(Math.random()*3);for(let i=0;i<wc;i++){const wt=3000+Math.random()*gt*.7;state.botGuessTimeouts.push(setTimeout(()=>{if(state.guessedPlayers.has(idx))return;const ww=WORDS[Math.floor(Math.random()*WORDS.length)];if(ww.toLowerCase()!==w.toLowerCase()){simulateBotSpeaking(idx);addChatMessage('player-msg',ww,p.name,Math.random()>.5);if(voiceChat.ttsEnabled&&Math.random()>.6)speakTTS(ww,.8+Math.random()*.5)}},wt))}
if(wg)state.botGuessTimeouts.push(setTimeout(()=>{if(state.guessedPlayers.has(idx))return;simulateBotSpeaking(idx);handleGuess(idx,w,true)},gt))})}

function simulateBotSpeaking(idx){state.speakingPlayers.add(idx);renderPlayers();renderVoiceMembers();setTimeout(()=>{state.speakingPlayers.delete(idx);renderPlayers();renderVoiceMembers()},1500+Math.random()*2000)}

// Game over
function showGameOver(){state.phase='gameover';const sorted=[...state.players].sort((a,b)=>b.score-a.score);document.getElementById('winnerName').textContent=sorted[0].name+' '+sorted[0].avatar;speakTTS(`Game over! The winner is ${sorted[0].name} with ${sorted[0].score} points!`);
const c=document.getElementById('finalScores');c.innerHTML='';const rl=['gold','silver','bronze'],re=['ü•á','ü•à','ü•â'];sorted.forEach((p,i)=>{const d=document.createElement('div');d.className='final-score-item'+(i===0?' first':'');d.innerHTML=`<div class="final-rank ${rl[i]||''}">${i<3?re[i]:'#'+(i+1)}</div><div class="final-name">${p.avatar} ${p.name}</div><div class="final-points">${p.score}</div>`;c.appendChild(d)});document.getElementById('gameOverOverlay').classList.add('active');stopVoiceChat()}

function backToLobby(){document.getElementById('gameOverOverlay').classList.remove('active');document.getElementById('game').style.display='none';document.getElementById('lobby').style.display='flex';document.getElementById('chatMessages').innerHTML='';clearInterval(state.timerInterval);state.botGuessTimeouts?.forEach(t=>clearTimeout(t));clearTimeout(state.botDrawTimeout);state.phase='lobby';stopVoiceChat()}

function toggleSound(){state.soundEnabled=!state.soundEnabled;document.querySelector('.top-bar-right .btn-icon').textContent=state.soundEnabled?'üîä':'üîá'}

// =========================================
// VOICE CHAT SYSTEM
// =========================================

function initVoiceVisualizer(){const v=document.getElementById('voiceVisualizer');if(!v)return;v.innerHTML='';for(let i=0;i<voiceChat.vizBars;i++){const b=document.createElement('div');b.className='viz-bar';b.style.height='3px';v.appendChild(b)}}

function renderVoiceMembers(){const c=document.getElementById('voiceMembers');if(!c)return;c.innerHTML='';state.players.forEach((p,idx)=>{const isS=state.speakingPlayers.has(idx);const d=document.createElement('div');d.className='voice-member'+(isS?' speaking-active':'');d.innerHTML=`<div class="voice-member-avatar">${p.avatar}<div class="voice-ring"></div></div><div class="voice-member-info"><div class="voice-member-name">${p.name}${idx===state.myIndex?' (You)':''}</div><div class="voice-member-status">${isS?'üéôÔ∏è Speaking...':(idx===state.myIndex&&voiceChat.isListening?'üéôÔ∏è Mic on':'Connected')}</div></div><div class="voice-member-volume" id="volBars_${idx}">${[1,2,3,4,5].map(()=>`<div class="vol-bar ${isS?'active':''}" style="height:${isS?(15+Math.random()*85):30}%"></div>`).join('')}</div>`;c.appendChild(d)})}

function toggleMic(){voiceChat.isListening?stopVoiceChat():startVoiceChat()}

async function startVoiceChat(){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){addChatMessage('system','‚ö†Ô∏è Speech recognition not supported. Try Chrome!');return}
try{voiceChat.mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});voiceChat.audioContext=new(window.AudioContext||window.webkitAudioContext)();const src=voiceChat.audioContext.createMediaStreamSource(voiceChat.mediaStream);voiceChat.analyser=voiceChat.audioContext.createAnalyser();voiceChat.analyser.fftSize=64;src.connect(voiceChat.analyser);
voiceChat.recognition=new SR();voiceChat.recognition.continuous=true;voiceChat.recognition.interimResults=true;voiceChat.recognition.lang='en-US';
voiceChat.recognition.onresult=e=>{let interim='',final='';for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)final+=t;else interim+=t}
const te=document.getElementById('voiceTranscript');if(interim){te.textContent=`üéôÔ∏è "${interim}"`;te.classList.add('active');state.speakingPlayers.add(state.myIndex);renderPlayers();renderVoiceMembers()}
if(final){const g=final.trim();te.textContent=`‚úÖ "${g}"`;te.classList.add('active');setTimeout(()=>{te.classList.remove('active');te.textContent='Listening...'},2000);setTimeout(()=>{state.speakingPlayers.delete(state.myIndex);renderPlayers();renderVoiceMembers()},500);if(g&&!isMyTurn()&&!state.guessedPlayers.has(state.myIndex))handleGuess(state.myIndex,g,true)}};
voiceChat.recognition.onerror=e=>{if(e.error==='no-speech'||e.error==='aborted')return;document.getElementById('voiceTranscript').textContent=`Error: ${e.error}`};
voiceChat.recognition.onend=()=>{if(voiceChat.isListening&&voiceChat.mode==='toggle')try{voiceChat.recognition.start()}catch(e){}};
voiceChat.connected=true;voiceChat.isListening=true;if(voiceChat.mode==='toggle')voiceChat.recognition.start();
updateVoiceUI();startVisualizer();playVoiceOn();addChatMessage('system','üéôÔ∏è Voice chat connected! Speak your guesses.');document.getElementById('voiceStatusDot').classList.add('connected');document.getElementById('voiceStatusText').textContent='Voice chat connected'}
catch(err){console.error(err);addChatMessage('system','‚ö†Ô∏è Could not access microphone.');document.getElementById('voiceStatusDot').classList.add('error');document.getElementById('voiceStatusText').textContent='Mic access denied'}}

function startListening(){if(!voiceChat.recognition||!voiceChat.connected)return;try{voiceChat.recognition.start();voiceChat.isListening=true;updateVoiceUI()}catch(e){}}
function stopListening(){if(!voiceChat.recognition)return;try{voiceChat.recognition.stop();if(voiceChat.mode==='ptt'){voiceChat.isListening=false;updateVoiceUI()}}catch(e){}}

function stopVoiceChat(){if(voiceChat.recognition)try{voiceChat.recognition.stop()}catch(e){}voiceChat.recognition=null;if(voiceChat.mediaStream){voiceChat.mediaStream.getTracks().forEach(t=>t.stop());voiceChat.mediaStream=null}if(voiceChat.audioContext){voiceChat.audioContext.close();voiceChat.audioContext=null}if(voiceChat.vizAnimFrame){cancelAnimationFrame(voiceChat.vizAnimFrame);voiceChat.vizAnimFrame=null}voiceChat.isListening=false;voiceChat.connected=false;voiceChat.analyser=null;state.speakingPlayers.delete(state.myIndex);updateVoiceUI();playVoiceOff();document.getElementById('voiceStatusDot').className='voice-status-dot';document.getElementById('voiceStatusText').textContent='Voice chat disconnected';const vt=document.getElementById('voiceTranscript');vt.textContent='Press mic to start speaking';vt.classList.remove('active');renderPlayers();renderVoiceMembers();resetVisualizerBars()}

function updateVoiceUI(){const b=document.getElementById('btnMic'),l=document.getElementById('micBtnLabel');if(voiceChat.isListening){b.classList.add('mic-active','listening');l.textContent=voiceChat.mode==='ptt'?'Talking...':'Listening...'}else if(voiceChat.connected){b.classList.add('mic-active');b.classList.remove('listening');l.textContent=voiceChat.mode==='ptt'?'Hold Space':'Mic On'}else{b.classList.remove('mic-active','listening');l.textContent='Start Mic'}
document.getElementById('voiceHint').textContent=voiceChat.connected?(voiceChat.mode==='ptt'?'Hold SPACE to talk, release to send':'Speak your guesses ‚Äî auto-submitted!'):'Speak your guesses ‚Äî voice recognition will submit them!'}

function toggleVoiceMode(m){voiceChat.mode=m;document.getElementById('modeToggle').classList.toggle('active',m==='toggle');document.getElementById('modePTT').classList.toggle('active',m==='ptt');if(voiceChat.connected){if(m==='toggle')try{voiceChat.recognition.start();voiceChat.isListening=true}catch(e){}else try{voiceChat.recognition.stop();voiceChat.isListening=false}catch(e){}updateVoiceUI()}}

function toggleMute(){voiceChat.isMuted=!voiceChat.isMuted;const b=document.getElementById('btnMute');b.textContent=voiceChat.isMuted?'üîá':'üîà';b.classList.toggle('active',voiceChat.isMuted)}

function toggleTTS(){voiceChat.ttsEnabled=!voiceChat.ttsEnabled;document.getElementById('btnTTS').classList.toggle('active',!voiceChat.ttsEnabled);addChatMessage('system',voiceChat.ttsEnabled?'üó£Ô∏è Bot voices enabled':'üîá Bot voices disabled')}

function speakTTS(text,rate=1){if(voiceChat.isMuted||!state.soundEnabled||!window.speechSynthesis)return;window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.rate=rate;u.pitch=.9+Math.random()*.3;u.volume=.7;const vs=window.speechSynthesis.getVoices();if(vs.length>0){const ev=vs.filter(v=>v.lang.startsWith('en'));if(ev.length>0)u.voice=ev[Math.floor(Math.random()*ev.length)]}window.speechSynthesis.speak(u)}

function startVisualizer(){if(!voiceChat.analyser)return;const bars=document.querySelectorAll('#voiceVisualizer .viz-bar'),bl=voiceChat.analyser.frequencyBinCount,da=new Uint8Array(bl);function anim(){if(!voiceChat.analyser)return;voiceChat.vizAnimFrame=requestAnimationFrame(anim);voiceChat.analyser.getByteFrequencyData(da);const step=Math.floor(bl/bars.length);for(let i=0;i<bars.length;i++){const v=da[i*step]||0,h=Math.max(3,(v/255)*36);bars[i].style.height=h+'px';bars[i].style.background=v/255>.3?`hsl(${260+(v/255)*40},80%,${50+(v/255)*20}%)`:'var(--border)'}}anim()}

function resetVisualizerBars(){document.querySelectorAll('#voiceVisualizer .viz-bar').forEach(b=>{b.style.height='3px';b.style.background='var(--border)'})}

// Animate bot volume bars
setInterval(()=>{state.speakingPlayers.forEach(idx=>{const bc=document.getElementById(`volBars_${idx}`);if(bc)bc.querySelectorAll('.vol-bar').forEach(b=>{b.classList.add('active');b.style.height=(15+Math.random()*85)+'%'})});state.players.forEach((_,idx)=>{if(!state.speakingPlayers.has(idx)){const bc=document.getElementById(`volBars_${idx}`);if(bc)bc.querySelectorAll('.vol-bar').forEach(b=>{b.classList.remove('active');b.style.height='30%'})}})},200);

if(window.speechSynthesis)window.speechSynthesis.onvoiceschanged=()=>{};
</script>
</body>
</html>
