<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DAMSHARAS GAME - Multiplayer Drawing & Guessing</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<style>
:root{--bg-primary:#0b0d17;--bg-secondary:#151829;--bg-card:#1c2038;--bg-input:#252a45;--accent-yellow:#ffd23f;--accent-green:#4ade80;--accent-blue:#60a5fa;--accent-pink:#f472b6;--accent-purple:#a78bfa;--accent-orange:#fb923c;--accent-red:#f87171;--text-primary:#e8eaf6;--text-secondary:#9ca3c4;--text-muted:#6b7194;--border:#2d3260;--correct-green:#22c55e;--shadow:0 8px 32px rgba(0,0,0,0.4)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(ellipse at 20% 50%,rgba(168,139,250,0.08) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,rgba(96,165,250,0.06) 0%,transparent 50%),radial-gradient(ellipse at 50% 80%,rgba(244,114,182,0.05) 0%,transparent 50%);z-index:0;pointer-events:none}

.screen{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;position:relative;z-index:1;padding:20px}
.screen.active{display:flex}
#gameScreen{padding:0}
#gameScreen.active{display:block}

.logo-container{text-align:center;margin-bottom:28px;animation:floatIn .8s ease-out}
@keyframes floatIn{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
.logo-title{font-family:'Fredoka One',cursive;font-size:52px;background:linear-gradient(135deg,var(--accent-yellow),var(--accent-orange),var(--accent-pink),var(--accent-purple));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 4px 8px rgba(255,210,63,0.3));letter-spacing:2px}
.logo-subtitle{font-size:15px;color:var(--text-secondary);margin-top:4px;letter-spacing:3px;text-transform:uppercase}

.card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:32px;width:100%;max-width:460px;box-shadow:var(--shadow);animation:floatIn .8s ease-out .2s both}
.card h2{font-family:'Fredoka One',cursive;font-size:21px;color:var(--accent-yellow);margin-bottom:20px;text-align:center}
.input-group{margin-bottom:14px}
.input-group label{display:block;font-weight:700;font-size:12px;color:var(--text-secondary);margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}
.input-group input,.input-group select{width:100%;padding:11px 14px;border:2px solid var(--border);border-radius:12px;background:var(--bg-input);color:var(--text-primary);font-family:'Nunito',sans-serif;font-size:15px;font-weight:600;transition:border-color .3s;outline:none}
.input-group input:focus,.input-group select:focus{border-color:var(--accent-yellow)}
.input-group select option{background:var(--bg-card)}
.settings-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.avatar-selection{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
.avatar-option{width:44px;height:44px;border-radius:50%;border:3px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all .2s;background:var(--bg-input)}
.avatar-option:hover{transform:scale(1.15)}
.avatar-option.selected{border-color:var(--accent-yellow);box-shadow:0 0 12px rgba(255,210,63,0.4)}

.btn{width:100%;padding:14px;border:none;border-radius:14px;font-family:'Fredoka One',cursive;font-size:18px;cursor:pointer;transition:all .3s;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px}
.btn:last-child{margin-bottom:0}
.btn-primary{background:linear-gradient(135deg,var(--accent-yellow),var(--accent-orange));color:#1a1a2e;box-shadow:0 4px 20px rgba(255,210,63,0.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(255,210,63,0.45)}
.btn-online{background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple));color:#fff;box-shadow:0 4px 20px rgba(96,165,250,0.3)}
.btn-online:hover{transform:translateY(-2px);box-shadow:0 6px 28px rgba(96,165,250,0.45)}
.btn-secondary{background:var(--bg-input);color:var(--text-primary);border:2px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent-green);transform:translateY(-2px)}
.btn-danger{background:rgba(248,113,113,0.15);color:var(--accent-red);border:2px solid rgba(248,113,113,0.3);font-size:15px}
.btn-danger:hover{background:rgba(248,113,113,0.25)}
.btn:disabled{opacity:.4;pointer-events:none}
.btn-sm{font-size:14px;padding:10px}

.or-divider{display:flex;align-items:center;gap:14px;margin:16px 0;color:var(--text-muted);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:2px}
.or-divider::before,.or-divider::after{content:'';flex:1;height:1px;background:var(--border)}

.mode-badge{font-size:10px;padding:2px 8px;border-radius:6px;font-weight:800;letter-spacing:.5px;text-transform:uppercase;font-family:'Nunito',sans-serif}
.mode-badge.local{background:rgba(255,210,63,0.15);color:var(--accent-yellow)}
.mode-badge.online{background:rgba(96,165,250,0.15);color:var(--accent-blue)}
.mode-desc{font-size:11px;color:var(--text-muted);font-family:'Nunito',sans-serif;font-weight:600}

/* Room code */
.room-code-display{text-align:center;margin:16px 0}
.room-code-display label{display:block;font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-weight:700}
.room-code{font-family:'Fredoka One',cursive;font-size:38px;letter-spacing:8px;color:var(--accent-yellow);background:var(--bg-input);border:2px dashed var(--accent-yellow);border-radius:16px;padding:14px 28px;display:inline-block;cursor:pointer;transition:all .2s;position:relative}
.room-code:hover{background:rgba(255,210,63,0.08)}
.room-code .copy-hint{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:11px;color:var(--text-muted);font-family:'Nunito',sans-serif;letter-spacing:0;white-space:nowrap}
.room-code.copied{border-color:var(--accent-green)}
.room-code.copied .copy-hint{color:var(--accent-green)}
.room-code.online-code{color:var(--accent-blue);border-color:var(--accent-blue)}
.room-code.online-code:hover{background:rgba(96,165,250,0.08)}

.waiting-players{display:flex;flex-direction:column;gap:6px;margin:12px 0;max-height:220px;overflow-y:auto}
.waiting-player{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-input);border-radius:12px;border:1px solid var(--border);animation:msgIn .2s ease-out}
.waiting-player .wp-avatar{font-size:20px}
.waiting-player .wp-name{font-weight:700;flex:1;font-size:14px}
.wp-badge{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:2px 7px;border-radius:5px}
.wp-badge.host{background:rgba(255,210,63,0.15);color:var(--accent-yellow)}
.wp-badge.you{background:rgba(96,165,250,0.15);color:var(--accent-blue)}
.player-count{font-size:13px;color:var(--text-muted);text-align:center;margin:6px 0}
.connection-status{font-size:12px;text-align:center;padding:8px;border-radius:10px;margin-bottom:12px}
.connection-status.connecting{background:rgba(251,146,60,0.1);color:var(--accent-orange)}
.connection-status.connected{background:rgba(74,222,128,0.1);color:var(--accent-green)}
.connection-status.error{background:rgba(248,113,113,0.1);color:var(--accent-red)}

/* ===== GAME ===== */
.top-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--bg-secondary);border-bottom:1px solid var(--border);height:60px}
.top-bar-left{display:flex;align-items:center;gap:16px}
.game-logo{font-family:'Fredoka One',cursive;font-size:22px;background:linear-gradient(135deg,var(--accent-yellow),var(--accent-orange));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.round-info{font-weight:700;color:var(--text-secondary);font-size:13px}
.round-info span{color:var(--accent-blue)}
.top-bar-center{display:flex;align-items:center;gap:14px}
.timer-circle{width:44px;height:44px;border-radius:50%;border:3px solid var(--accent-blue);display:flex;align-items:center;justify-content:center;font-family:'Fredoka One',cursive;font-size:18px;color:var(--accent-blue);transition:all .3s}
.timer-circle.warning{border-color:var(--accent-orange);color:var(--accent-orange)}
.timer-circle.danger{border-color:var(--accent-red);color:var(--accent-red);animation:pulse .5s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.word-display{font-family:'Fredoka One',cursive;font-size:26px;letter-spacing:6px;color:var(--text-primary);min-width:180px;text-align:center}
.word-display.hint{color:var(--accent-yellow)}
.top-bar-right{display:flex;align-items:center;gap:8px}
.btn-icon{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s}
.btn-icon:hover{border-color:var(--accent-yellow);color:var(--accent-yellow)}

.game-main{display:grid;grid-template-columns:200px 1fr 280px;height:calc(100vh - 60px)}

.players-panel{background:var(--bg-secondary);border-right:1px solid var(--border);overflow-y:auto;padding:8px}
.player-card{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;margin-bottom:5px;background:var(--bg-card);border:1px solid transparent;transition:all .3s;position:relative}
.player-card.drawing{border-color:var(--accent-yellow);background:rgba(255,210,63,0.08)}
.player-card.guessed{border-color:var(--correct-green);background:rgba(34,197,94,0.08)}
.player-card.speaking{border-color:var(--accent-purple);background:rgba(167,139,250,0.1)}
.player-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;position:relative}
.player-card.speaking .player-avatar::after{content:'';position:absolute;inset:-4px;border-radius:50%;border:2px solid var(--accent-purple);animation:voiceRing .8s ease-out infinite}
@keyframes voiceRing{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}
.player-info{flex:1;min-width:0}
.player-name{font-weight:700;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.player-score{font-size:10px;color:var(--text-muted);font-weight:600}
.player-rank{font-family:'Fredoka One',cursive;font-size:13px;color:var(--accent-yellow);width:22px;text-align:center}
.drawing-indicator{position:absolute;top:4px;right:6px;font-size:12px;animation:bounce 1s infinite}
.voice-indicator{position:absolute;bottom:4px;right:6px;font-size:10px;color:var(--accent-purple)}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}

.canvas-area{display:flex;flex-direction:column;background:var(--bg-primary);position:relative}
.canvas-wrapper{flex:1;display:flex;align-items:center;justify-content:center;padding:8px;position:relative}
#drawCanvas{background:#fff;border-radius:12px;cursor:crosshair;box-shadow:0 4px 30px rgba(0,0,0,0.5);max-width:100%;max-height:100%}
.toolbar{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 12px;background:var(--bg-secondary);border-top:1px solid var(--border);flex-wrap:wrap}
.toolbar.disabled{opacity:.3;pointer-events:none}
.color-palette{display:flex;gap:3px;flex-wrap:wrap;max-width:300px}
.color-btn{width:26px;height:26px;border-radius:5px;border:2px solid transparent;cursor:pointer;transition:all .15s}
.color-btn:hover{transform:scale(1.2)}
.color-btn.selected{border-color:white;box-shadow:0 0 8px rgba(255,255,255,0.4);transform:scale(1.15)}
.tool-separator{width:1px;height:30px;background:var(--border);margin:0 3px}
.tool-btn{width:34px;height:34px;border-radius:8px;border:2px solid var(--border);background:var(--bg-card);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s}
.tool-btn:hover{border-color:var(--accent-blue);color:var(--accent-blue)}
.tool-btn.selected{border-color:var(--accent-yellow);color:var(--accent-yellow);background:rgba(255,210,63,0.1)}
.brush-sizes{display:flex;gap:5px;align-items:center}
.brush-size-btn{border-radius:50%;border:2px solid var(--border);background:var(--bg-card);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.brush-size-btn .dot{border-radius:50%;background:var(--text-secondary)}
.brush-size-btn.selected{border-color:var(--accent-yellow)}
.brush-size-btn.selected .dot{background:var(--accent-yellow)}

.right-panel{display:flex;flex-direction:column;border-left:1px solid var(--border);background:var(--bg-secondary)}
.panel-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg-card)}
.panel-tab{flex:1;padding:10px 8px;text-align:center;font-weight:800;font-size:12px;color:var(--text-muted);cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:1px;border-bottom:3px solid transparent;user-select:none}
.panel-tab:hover{color:var(--text-secondary)}
.panel-tab.active{color:var(--accent-yellow);border-bottom-color:var(--accent-yellow)}
.chat-panel{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chat-panel.hidden{display:none}
.chat-messages{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:3px}
.chat-msg{padding:5px 10px;border-radius:8px;font-size:12px;animation:msgIn .2s ease-out;word-break:break-word}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.chat-msg.system{color:var(--text-muted);font-style:italic;text-align:center;font-size:11px}
.chat-msg.correct{background:rgba(34,197,94,0.12);color:var(--correct-green);font-weight:700;text-align:center;border:1px solid rgba(34,197,94,0.2)}
.chat-msg.player-msg{background:var(--bg-card)}
.chat-msg.player-msg .msg-author{font-weight:800;margin-right:5px}
.chat-msg.close-guess{background:rgba(251,146,60,0.12);color:var(--accent-orange);font-weight:600;text-align:center}
.chat-msg.voice-msg{border-left:3px solid var(--accent-purple)}
.voice-badge{display:inline-block;background:var(--accent-purple);color:#fff;font-size:8px;font-weight:800;padding:1px 4px;border-radius:3px;margin-left:4px;vertical-align:middle}
.chat-input-area{padding:8px;border-top:1px solid var(--border)}
.chat-input-area input{width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:12px;background:var(--bg-input);color:var(--text-primary);font-family:'Nunito',sans-serif;font-size:13px;font-weight:600;outline:none;transition:border-color .3s}
.chat-input-area input:focus{border-color:var(--accent-blue)}
.chat-input-area input:disabled{opacity:.4}

.voice-panel{flex:1;display:none;flex-direction:column;overflow:hidden}
.voice-panel.active{display:flex}
.voice-status-bar{padding:8px 12px;display:flex;align-items:center;gap:7px;border-bottom:1px solid var(--border);font-size:11px;color:var(--text-secondary)}
.voice-status-dot{width:7px;height:7px;border-radius:50%;background:var(--text-muted);flex-shrink:0}
.voice-status-dot.connected{background:var(--accent-green);box-shadow:0 0 6px rgba(74,222,128,0.5)}
.voice-members{flex:1;overflow-y:auto;padding:8px}
.voice-member{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;margin-bottom:5px;background:var(--bg-card);border:1px solid transparent;transition:all .3s}
.voice-member.speaking-active{border-color:var(--accent-purple);background:rgba(167,139,250,0.08)}
.voice-member-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;position:relative}
.voice-member-avatar .voice-ring{display:none;position:absolute;inset:-3px;border-radius:50%;border:2px solid var(--accent-purple)}
.voice-member.speaking-active .voice-ring{display:block;animation:voiceRing .8s ease-out infinite}
.voice-member-info{flex:1}
.voice-member-name{font-weight:700;font-size:12px}
.voice-member-status{font-size:10px;color:var(--text-muted)}
.voice-controls{padding:12px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px}
.voice-visualizer{height:36px;display:flex;align-items:flex-end;justify-content:center;gap:2px;padding:3px 0}
.viz-bar{width:3px;background:var(--border);border-radius:2px;transition:height .08s ease;min-height:3px}
.voice-btns{display:flex;gap:6px;align-items:center}
.btn-voice{flex:1;padding:10px;border:2px solid var(--border);border-radius:10px;background:var(--bg-card);color:var(--text-primary);font-family:'Nunito',sans-serif;font-weight:700;font-size:12px;cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;gap:5px}
.btn-voice:hover{border-color:var(--accent-purple)}
.btn-voice.mic-active{border-color:var(--accent-purple);background:rgba(167,139,250,0.15);color:var(--accent-purple);box-shadow:0 0 16px rgba(167,139,250,0.2)}
.btn-voice.mic-active.listening{animation:micPulse 1.5s ease-in-out infinite}
@keyframes micPulse{0%,100%{box-shadow:0 0 16px rgba(167,139,250,0.2)}50%{box-shadow:0 0 28px rgba(167,139,250,0.45)}}
.btn-voice-small{width:38px;height:38px;border:2px solid var(--border);border-radius:8px;background:var(--bg-card);color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0}
.btn-voice-small:hover{border-color:var(--accent-purple);color:var(--accent-purple)}
.btn-voice-small.active{border-color:var(--accent-red);color:var(--accent-red)}
.voice-mode-toggle{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.voice-mode-btn{flex:1;padding:5px 8px;font-size:10px;font-weight:700;text-align:center;cursor:pointer;background:var(--bg-input);color:var(--text-muted);transition:all .2s;border:none;text-transform:uppercase;letter-spacing:.5px}
.voice-mode-btn.active{background:var(--accent-purple);color:#fff}
.voice-transcript{font-size:11px;color:var(--text-muted);text-align:center;min-height:16px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.voice-transcript.active{color:var(--accent-purple);font-style:normal}
.voice-hint{font-size:10px;color:var(--text-muted);text-align:center}

.overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(11,13,23,0.85);backdrop-filter:blur(8px);z-index:100;align-items:center;justify-content:center}
.overlay.active{display:flex}
.overlay-card{background:var(--bg-card);border:1px solid var(--border);border-radius:24px;padding:36px;text-align:center;box-shadow:var(--shadow);animation:popIn .4s cubic-bezier(0.34,1.56,0.64,1);min-width:360px;max-width:500px}
@keyframes popIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
.overlay-card h2{font-family:'Fredoka One',cursive;font-size:22px;color:var(--accent-yellow);margin-bottom:18px}
.word-options{display:flex;gap:12px;justify-content:center}
.word-option{padding:14px 28px;border:2px solid var(--border);border-radius:14px;background:var(--bg-input);color:var(--text-primary);font-family:'Fredoka One',cursive;font-size:17px;cursor:pointer;transition:all .3s}
.word-option:hover{border-color:var(--accent-yellow);background:rgba(255,210,63,0.1);transform:translateY(-4px);box-shadow:0 8px 24px rgba(255,210,63,0.2)}
.word-reveal{font-size:15px;color:var(--text-secondary);margin-bottom:20px}
.word-reveal span{color:var(--accent-yellow);font-weight:800}
.score-list{display:flex;flex-direction:column;gap:6px;margin-bottom:20px}
.score-item{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--bg-input);border-radius:8px;font-size:13px}
.score-item .name{font-weight:700}.score-item .points{color:var(--accent-green);font-weight:800}
.game-over-panel h1{font-family:'Fredoka One',cursive;font-size:32px;background:linear-gradient(135deg,var(--accent-yellow),var(--accent-orange));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
.winner-info{font-size:16px;color:var(--text-secondary);margin-bottom:24px}
.winner-info .winner-name{color:var(--accent-yellow);font-weight:800;font-size:20px}
.final-scores{display:flex;flex-direction:column;gap:6px;margin-bottom:24px}
.final-score-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--bg-input);border-radius:10px}
.final-score-item.first{border:2px solid var(--accent-yellow);background:rgba(255,210,63,0.08)}
.final-rank{font-family:'Fredoka One',cursive;font-size:16px;width:28px}
.final-rank.gold{color:var(--accent-yellow)}.final-rank.silver{color:#c0c0c0}.final-rank.bronze{color:#cd7f32}
.final-name{flex:1;text-align:left;font-weight:700;font-size:14px}
.final-points{font-family:'Fredoka One',cursive;color:var(--accent-green);font-size:16px}

::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:900px){.game-main{grid-template-columns:1fr;grid-template-rows:auto 1fr auto}.players-panel{display:flex;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border);padding:5px;gap:5px}.player-card{min-width:120px;margin-bottom:0}.right-panel{max-height:240px}.logo-title{font-size:36px}}
</style>
</head>
<body>

<!-- HOME -->
<div class="screen active" id="homeScreen">
  <div class="logo-container"><div class="logo-title">DAMSHARAS</div><div class="logo-subtitle">Drawing & Guessing Game</div></div>
  <div class="card">
    <h2>üé® Play with Friends</h2>
    <div class="input-group"><label>Your Name</label><input type="text" id="playerName" placeholder="Enter your name..." maxlength="16"></div>
    <div class="input-group"><label>Choose Avatar</label><div class="avatar-selection" id="avatarSelection"></div></div>
    <button class="btn btn-primary" onclick="createRoom('local')">üè† Create Local Room<span class="mode-desc" style="margin-left:6px;color:#1a1a2e99">Same browser</span></button>
    <button class="btn btn-online" onclick="createRoom('online')">üåê Create Online Room<span class="mode-desc" style="margin-left:6px;color:#fff9">Cross-device</span></button>
    <div class="or-divider"><span>OR JOIN</span></div>
    <div class="input-group"><label>Room Code</label><input type="text" id="joinCode" placeholder="Enter room code..." maxlength="8" style="text-transform:uppercase;letter-spacing:3px;text-align:center;font-family:'Fredoka One',cursive;font-size:18px"></div>
    <button class="btn btn-secondary" onclick="joinRoom()">üö™ Join Room</button>
  </div>
</div>

<!-- WAITING -->
<div class="screen" id="waitingScreen">
  <div class="logo-container"><div class="logo-title">DAMSHARAS</div><div class="logo-subtitle">Waiting Room</div></div>
  <div class="card">
    <h2 id="waitingTitle">üè† Your Room</h2>
    <div class="connection-status" id="connStatus" style="display:none"></div>
    <div class="room-code-display">
      <label>Share this code with friends</label>
      <div class="room-code" id="roomCodeDisplay" onclick="copyRoomCode()">
        <span id="roomCodeText">------</span>
        <span class="copy-hint" id="copyHint">Click to copy</span>
      </div>
    </div>
    <div style="text-align:center;margin:6px 0"><span class="mode-badge" id="modeBadge">LOCAL</span></div>
    <div class="player-count" id="playerCount">1 player waiting...</div>
    <div class="waiting-players" id="waitingPlayers"></div>
    <div class="settings-row" id="hostSettings">
      <div class="input-group"><label>Rounds</label><select id="roundsSelect"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option></select></div>
      <div class="input-group"><label>Draw Time</label><select id="drawTimeSelect"><option value="40">40s</option><option value="60">60s</option><option value="80" selected>80s</option><option value="100">100s</option><option value="120">120s</option></select></div>
    </div>
    <button class="btn btn-primary" id="startGameBtn" onclick="hostStartGame()" disabled>‚è≥ Waiting for players...</button>
    <button class="btn btn-danger btn-sm" onclick="leaveRoom()" style="width:100%;margin-top:8px">Leave Room</button>
    <p style="font-size:10px;color:var(--text-muted);text-align:center;margin-top:10px" id="waitingHint"></p>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="gameScreen">
  <div class="top-bar">
    <div class="top-bar-left"><div class="game-logo">DAMSHARAS</div><div class="round-info">Round <span id="roundNum">1</span> of <span id="totalRounds">3</span></div></div>
    <div class="top-bar-center"><div class="timer-circle" id="timer">80</div><div class="word-display" id="wordDisplay">_ _ _ _ _</div></div>
    <div class="top-bar-right"><button class="btn-icon" onclick="toggleSound()">üîä</button></div>
  </div>
  <div class="game-main">
    <div class="players-panel" id="playersList"></div>
    <div class="canvas-area">
      <div class="canvas-wrapper"><canvas id="drawCanvas" width="780" height="520"></canvas></div>
      <div class="toolbar" id="toolbar">
        <div class="color-palette" id="colorPalette"></div><div class="tool-separator"></div>
        <div class="brush-sizes" id="brushSizes"></div><div class="tool-separator"></div>
        <button class="tool-btn" id="btnPencil" onclick="setTool('pencil')">‚úèÔ∏è</button>
        <button class="tool-btn" id="btnEraser" onclick="setTool('eraser')">üßπ</button>
        <button class="tool-btn" id="btnFill" onclick="setTool('fill')">ü™£</button>
        <button class="tool-btn" onclick="undoDraw()">‚Ü©Ô∏è</button>
        <button class="tool-btn" onclick="clearCanvas()">üóëÔ∏è</button>
      </div>
    </div>
    <div class="right-panel">
      <div class="panel-tabs">
        <div class="panel-tab active" id="tabChat" onclick="switchTab('chat')">üí¨ Chat</div>
        <div class="panel-tab" id="tabVoice" onclick="switchTab('voice')">üéôÔ∏è Voice</div>
      </div>
      <div class="chat-panel" id="chatPanelContent">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area"><input type="text" id="chatInput" placeholder="Type your guess..." maxlength="50" autocomplete="off"></div>
      </div>
      <div class="voice-panel" id="voicePanelContent">
        <div class="voice-status-bar"><div class="voice-status-dot" id="voiceStatusDot"></div><span id="voiceStatusText">Disconnected</span></div>
        <div class="voice-members" id="voiceMembers"></div>
        <div class="voice-controls">
          <div class="voice-visualizer" id="voiceVisualizer"></div>
          <div class="voice-transcript" id="voiceTranscript">Press mic to start</div>
          <div class="voice-mode-toggle"><button class="voice-mode-btn active" id="modeToggle" onclick="toggleVoiceMode('toggle')">Toggle</button><button class="voice-mode-btn" id="modePTT" onclick="toggleVoiceMode('ptt')">Push to Talk</button></div>
          <div class="voice-btns">
            <button class="btn-voice" id="btnMic" onclick="toggleMic()"><span>üéôÔ∏è</span><span id="micBtnLabel">Start Mic</span></button>
            <button class="btn-voice-small" id="btnMute" onclick="toggleMute()">üîà</button>
          </div>
          <div class="voice-hint" id="voiceHint">Speak guesses ‚Äî voice auto-submits!</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OVERLAYS -->
<div class="overlay" id="wordSelectOverlay"><div class="overlay-card"><h2>‚ú® Choose a word to draw!</h2><div class="word-options" id="wordOptions"></div></div></div>
<div class="overlay" id="roundResultOverlay"><div class="overlay-card"><h2 id="roundResultTitle">‚è∞ Time's Up!</h2><div class="word-reveal">The word was: <span id="revealWord"></span></div><div class="score-list" id="roundScores"></div></div></div>
<div class="overlay" id="gameOverOverlay"><div class="overlay-card game-over-panel"><h1>üèÜ Game Over!</h1><div class="winner-info">Winner: <span class="winner-name" id="winnerName"></span></div><div class="final-scores" id="finalScores"></div><button class="btn btn-primary" onclick="backToLobby()">Play Again</button></div></div>

<script>
// ===== CONSTANTS =====
const WORDS=["apple","banana","car","dog","elephant","fish","guitar","house","ice cream","jacket","kite","lion","moon","notebook","ocean","pizza","queen","rainbow","sun","tree","umbrella","volcano","whale","xylophone","yacht","zebra","airplane","butterfly","castle","diamond","eagle","flower","ghost","hamburger","island","jellyfish","kangaroo","lighthouse","mountain","necklace","octopus","penguin","robot","snowflake","telescope","unicorn","violin","waterfall","computer","dragon","firework","giraffe","helicopter","igloo","jungle","keyboard","lemon","mushroom","ninja","parachute","sandwich","tornado","wizard","astronaut","bicycle","cactus","dolphin","feather","grapes","hammer","lamp","magnet","orange","pillow","rocket","scissors","trophy","anchor","bridge","candle","drum","envelope","frog","globe","heart","insect","jewel","ladder","mirror","nest","paint","ring","skull","sword","tent","vacuum","window","arrow","battery","cherry","dice","egg","flag","glasses","harp","iron","jar","key","leaf","medal","net","owl","pearl","quilt","rope","snake","tiger","vase","watch","angel","boat","crown","door","earth","forest","garden","horse","iceberg","juice","king","library","marble","nurse","present","star","train","village","waffle","camera","dinosaur","emerald","football","gorilla","headphones","koala","lollipop","mermaid","newspaper","ostrich","pineapple","raccoon","satellite","trampoline","walrus","basketball","caterpillar","dragonfly","flamingo","grasshopper","harmonica","marshmallow","origami","platypus","rhinoceros","scarecrow","thunderstorm","watermelon","broccoli","chandelier","fireplace","goldfish","hummingbird","chameleon","sunflower","surfboard","treasure","skateboard","spaceship","starfish","strawberry","superhero","toothbrush"];
const AVATARS=["üòÄ","üòé","ü§ì","ü•≥","üò∫","ü¶ä","üê∏","üêµ","üëª","ü§ñ","üëΩ","üéÉ","ü¶Ñ","üêº","üêß","ü¶Å"];
const DRAW_COLORS=["#000000","#555555","#8B4513","#FF0000","#FF8C00","#FFD700","#008000","#00CED1","#0000FF","#8A2BE2","#FF1493","#FFFFFF","#AAAAAA","#D2691E","#FF6347","#FFA500","#FFFF00","#7CFC00","#00FFFF","#1E90FF","#9370DB","#FF69B4"];
const BRUSH_SIZES=[{size:3,display:6},{size:6,display:10},{size:12,display:16},{size:22,display:22},{size:36,display:28}];

// ===== IDENTITY =====
const myId=crypto.randomUUID();
let myName='',myAvatar='üòÄ';

// ===== NETWORK ABSTRACTION =====
class Network{
  constructor(){this.onMsg=null;this.mode=null;this.bc=null;this.peer=null;this.conns=[];this.hostConn=null;this.isHost=false}
  
  createLocal(code){
    this.mode='local';this.isHost=true;this.bc=new BroadcastChannel('dam_'+code);
    this.bc.onmessage=e=>{if(e.data.sid!==myId&&this.onMsg)this.onMsg(e.data)};
    return Promise.resolve()
  }
  
  joinLocal(code){
    this.mode='local';this.isHost=false;this.bc=new BroadcastChannel('dam_'+code);
    this.bc.onmessage=e=>{if(e.data.sid!==myId&&this.onMsg)this.onMsg(e.data)};
    return Promise.resolve()
  }
  
  createOnline(code){
    this.mode='online';this.isHost=true;
    return new Promise((resolve,reject)=>{
      this.peer=new Peer('dam-'+code,{debug:0});
      this.peer.on('open',()=>{
        this.peer.on('connection',conn=>{
          conn.on('open',()=>{this.conns.push(conn);conn.on('data',d=>{if(d.sid!==myId){if(this.onMsg)this.onMsg(d);this.conns.forEach(c=>{if(c!==conn&&c.open)c.send(d)})}});conn.on('close',()=>{this.conns=this.conns.filter(c=>c!==conn)})});
        });resolve()
      });
      this.peer.on('error',e=>{console.error('PeerJS error:',e);reject(e)});
      setTimeout(()=>reject(new Error('Peer timeout')),15000)
    })
  }
  
  joinOnline(code){
    this.mode='online';this.isHost=false;
    return new Promise((resolve,reject)=>{
      this.peer=new Peer(undefined,{debug:0});
      this.peer.on('open',()=>{
        this.hostConn=this.peer.connect('dam-'+code,{reliable:true});
        this.hostConn.on('open',()=>{this.hostConn.on('data',d=>{if(d.sid!==myId&&this.onMsg)this.onMsg(d)});resolve()});
        this.hostConn.on('error',e=>reject(e));
        setTimeout(()=>reject(new Error('Connection timeout')),12000)
      });
      this.peer.on('error',e=>reject(e))
    })
  }
  
  send(msg){
    msg.sid=myId;
    if(this.mode==='local'&&this.bc){this.bc.postMessage(msg)}
    else if(this.mode==='online'){
      if(this.isHost){this.conns.forEach(c=>{if(c.open)c.send(msg)})}
      else if(this.hostConn&&this.hostConn.open){this.hostConn.send(msg)}
    }
  }
  
  destroy(){
    if(this.bc){this.bc.close();this.bc=null}
    if(this.peer){this.peer.destroy();this.peer=null}
    this.conns=[];this.hostConn=null;this.mode=null
  }
}

let net=new Network();

// ===== ROOM STATE =====
let room={code:null,mode:null,isHost:false,hostId:null,players:[]};

// ===== GAME STATE =====
let G={players:[],currentWord:'',round:1,totalRounds:3,drawTime:80,timeLeft:80,timerInterval:null,guessedPlayers:new Set(),turnOrder:[],turnIndex:0,soundEnabled:true,hintRevealed:[],phase:'lobby',speakingPlayers:new Set()};
let canvas,ctx,drawing=false,currentColor='#000000',currentSize=6,currentTool='pencil',drawHistory=[],strokeData=[];
let vc={recognition:null,isListening:false,mode:'toggle',isMuted:false,mediaStream:null,audioContext:null,analyser:null,vizBars:24,vizAnimFrame:null,connected:false,pttHeld:false};

// ===== SCREENS =====
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}

// ===== INIT =====
function initAvatars(){const c=document.getElementById('avatarSelection');c.innerHTML='';AVATARS.forEach((a,i)=>{const d=document.createElement('div');d.className='avatar-option'+(i===0?' selected':'');d.textContent=a;d.onclick=()=>{c.querySelectorAll('.avatar-option').forEach(e=>e.classList.remove('selected'));d.classList.add('selected')};c.appendChild(d)})}

function genCode(){const ch='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let c='';for(let i=0;i<6;i++)c+=ch[Math.floor(Math.random()*ch.length)];return c}
function getMe(){myName=document.getElementById('playerName').value.trim()||'Player';myAvatar=document.querySelector('.avatar-option.selected')?.textContent||'üòÄ';return{id:myId,name:myName,avatar:myAvatar,score:0}}

// ===== CREATE ROOM =====
async function createRoom(mode){
  const me=getMe();room.code=genCode();room.mode=mode;room.isHost=true;room.hostId=myId;room.players=[me];
  
  const cs=document.getElementById('connStatus');
  if(mode==='online'){
    cs.style.display='block';cs.className='connection-status connecting';cs.textContent='üîÑ Connecting to online server...';
    showScreen('waitingScreen');renderWaiting();
    try{
      await net.createOnline(room.code);
      cs.className='connection-status connected';cs.textContent='‚úÖ Online room ready!';
    }catch(e){
      cs.className='connection-status error';cs.textContent='‚ùå Failed to connect. Check your internet and try again.';return
    }
  }else{
    await net.createLocal(room.code);cs.style.display='none';
    showScreen('waitingScreen');
  }
  
  net.onMsg=handleNetMsg;
  net.send({type:'room-state',players:room.players,hostId:room.hostId,code:room.code});
  renderWaiting()
}

// ===== JOIN ROOM =====
async function joinRoom(){
  const code=document.getElementById('joinCode').value.trim().toUpperCase();
  if(code.length<4){alert('Enter a valid room code!');return}
  const me=getMe();room.code=code;room.isHost=false;
  
  showScreen('waitingScreen');
  const cs=document.getElementById('connStatus');
  cs.style.display='block';cs.className='connection-status connecting';cs.textContent='üîÑ Trying to connect...';
  renderWaiting();
  
  // Try online first
  try{
    await net.joinOnline(code);room.mode='online';
    cs.className='connection-status connected';cs.textContent='‚úÖ Connected online!';
    net.onMsg=handleNetMsg;
    net.send({type:'join',player:me});
    room.players=[me];renderWaiting();return
  }catch(e){console.log('Online join failed, trying local...')}
  
  // Fallback to local
  try{
    net.destroy();net=new Network();
    await net.joinLocal(code);room.mode='local';
    cs.className='connection-status connected';cs.textContent='‚úÖ Connected locally!';
    net.onMsg=handleNetMsg;
    net.send({type:'join',player:me});
    room.players=[me];
    // Request state
    setTimeout(()=>net.send({type:'request-state',from:me}),300);
    renderWaiting()
  }catch(e2){
    cs.className='connection-status error';cs.textContent='‚ùå Room not found. Check the code and try again.'
  }
}

// ===== NETWORK MESSAGE HANDLER =====
function handleNetMsg(msg){
  switch(msg.type){
    case'join':
      if(room.isHost){
        if(!room.players.find(p=>p.id===msg.player.id))room.players.push(msg.player);
        net.send({type:'room-state',players:room.players,hostId:room.hostId,code:room.code});renderWaiting()
      }break;
    case'request-state':
      if(room.isHost)net.send({type:'room-state',players:room.players,hostId:room.hostId,code:room.code});break;
    case'room-state':
      room.players=msg.players;room.hostId=msg.hostId;
      if(!room.players.find(p=>p.id===myId)){const me=getMe();room.players.push(me)}
      renderWaiting();break;
    case'start-game':
      G.totalRounds=msg.rounds;G.drawTime=msg.drawTime;G.turnOrder=msg.turnOrder;room.players=msg.players;
      startGameFromRoom();break;
    case'draw-data':
      if(msg.action==='stroke')replayStroke(msg.data);
      else if(msg.action==='clear'&&ctx){ctx.fillStyle='#fff';ctx.fillRect(0,0,canvas.width,canvas.height)}
      else if(msg.action==='fill')replayFill(msg.data);
      else if(msg.action==='undo')replayUndo(msg.data);break;
    case'guess':handleRemoteGuess(msg);break;
    case'guess-correct':
      G.guessedPlayers.add(msg.playerId);G.players=msg.scores||G.players;playCorrect();
      addChat('correct',`üéâ ${msg.playerName} guessed it! (+${msg.points})`);
      if(msg.playerId===myId){document.getElementById('chatInput').disabled=true;document.getElementById('chatInput').placeholder='You guessed it! ‚úÖ'}
      renderPlayers();break;
    case'chat':addChat('player-msg',msg.text,msg.author,msg.isVoice);break;
    case'close-guess':addChat('close-guess',msg.text);break;
    case'turn-start':handleTurnStart(msg);break;
    case'word-chosen':handleWordChosen(msg);break;
    case'turn-end':handleTurnEnd(msg);break;
    case'game-over':handleGameOver(msg);break;
    case'hint':handleHint(msg);break;
    case'player-left':
      room.players=room.players.filter(p=>p.id!==msg.pid);G.players=G.players.filter(p=>p.id!==msg.pid);
      renderWaiting();renderPlayers();addChat('system',msg.pname+' left.');break;
    case'speaking':
      if(msg.on)G.speakingPlayers.add(msg.pid);else G.speakingPlayers.delete(msg.pid);
      renderPlayers();renderVoiceMembers();break;
  }
}

// ===== WAITING ROOM =====
function renderWaiting(){
  document.getElementById('roomCodeText').textContent=room.code||'------';
  const rc=document.getElementById('roomCodeDisplay');
  rc.className='room-code'+(room.mode==='online'?' online-code':'');
  document.getElementById('playerCount').textContent=room.players.length+' player'+(room.players.length!==1?'s':'')+' in room';
  const mb=document.getElementById('modeBadge');
  mb.className='mode-badge '+(room.mode==='online'?'online':'local');
  mb.textContent=room.mode==='online'?'üåê ONLINE':'üè† LOCAL';
  
  const c=document.getElementById('waitingPlayers');c.innerHTML='';
  room.players.forEach(p=>{const d=document.createElement('div');d.className='waiting-player';
    let badges='';if(p.id===room.hostId)badges+='<span class="wp-badge host">üëë Host</span>';if(p.id===myId)badges+='<span class="wp-badge you">You</span>';
    d.innerHTML=`<span class="wp-avatar">${p.avatar}</span><span class="wp-name">${p.name}</span>${badges}`;c.appendChild(d)});
  
  const isHost=room.hostId===myId;
  document.getElementById('hostSettings').style.display=isHost?'grid':'none';
  const btn=document.getElementById('startGameBtn');
  btn.style.display=isHost?'flex':'none';
  btn.disabled=room.players.length<2;
  btn.textContent=room.players.length<2?'‚è≥ Waiting for players...':'üéÆ START ('+room.players.length+' players)';
  document.getElementById('waitingHint').textContent=room.mode==='online'?'üí° Share the room code ‚Äî friends join from any device!':'üí° Open another tab at this page & join with the code to play!';
}

function copyRoomCode(){navigator.clipboard?.writeText(room.code);const el=document.getElementById('roomCodeDisplay');el.classList.add('copied');document.getElementById('copyHint').textContent='Copied!';setTimeout(()=>{el.classList.remove('copied');document.getElementById('copyHint').textContent='Click to copy'},2000)}
function leaveRoom(){net.send({type:'player-left',pid:myId,pname:myName});net.destroy();net=new Network();room={code:null,mode:null,isHost:false,hostId:null,players:[]};showScreen('homeScreen')}

// ===== START GAME =====
function hostStartGame(){
  const turnOrder=room.players.map(p=>p.id).sort(()=>Math.random()-.5);
  const rounds=parseInt(document.getElementById('roundsSelect').value);
  const dt=parseInt(document.getElementById('drawTimeSelect').value);
  const ps=room.players.map(p=>({...p,score:0}));
  net.send({type:'start-game',players:ps,turnOrder,rounds,drawTime:dt});
  G.totalRounds=rounds;G.drawTime=dt;G.turnOrder=turnOrder;room.players=ps;startGameFromRoom()
}

function startGameFromRoom(){
  G.players=room.players.map(p=>({...p,score:p.score||0}));G.round=1;G.turnIndex=0;G.phase='playing';
  showScreen('gameScreen');initCanvas();initToolbar();initViz();renderPlayers();renderVoiceMembers();
  document.getElementById('totalRounds').textContent=G.totalRounds;document.getElementById('chatMessages').innerHTML='';
  addChat('system','Game started! Good luck!');
  if(room.hostId===myId)hostStartTurn()
}

function amIDrawing(){return G.turnOrder[G.turnIndex]===myId}
function getDrawerId(){return G.turnOrder[G.turnIndex]}

// ===== TURNS =====
function hostStartTurn(){
  G.guessedPlayers=new Set();G.hintRevealed=[];G.speakingPlayers=new Set();
  const did=getDrawerId();const words=[...WORDS].sort(()=>Math.random()-.5).slice(0,3);
  net.send({type:'turn-start',did,round:G.round,words:did===myId?words:undefined,wordsForDrawer:words,wl:words[0].length});
  handleTurnStart({did,round:G.round,words:did===myId?words:undefined,wordsForDrawer:did===myId?words:undefined})
}

function handleTurnStart(msg){
  G.guessedPlayers=new Set();G.hintRevealed=[];G.speakingPlayers=new Set();G.currentWord='';G.round=msg.round||G.round;
  if(ctx){ctx.fillStyle='#fff';ctx.fillRect(0,0,canvas.width,canvas.height)}drawHistory=[];if(ctx)saveHistory();
  const dr=G.players.find(p=>p.id===msg.did);document.getElementById('roundNum').textContent=G.round;
  addChat('system',(dr?.name||'Someone')+' is drawing!');renderPlayers();
  document.getElementById('toolbar').classList.toggle('disabled',!amIDrawing());
  document.getElementById('chatInput').disabled=amIDrawing();
  document.getElementById('chatInput').placeholder=amIDrawing()?'You are drawing!':'Type your guess...';
  
  if(amIDrawing()){
    // If host sent words for me, or I am host and have wordsForDrawer
    const w=msg.words||msg.wordsForDrawer;
    if(w)showWordSelection(w);
  }else{
    document.getElementById('wordDisplay').textContent='? ? ?';document.getElementById('wordDisplay').classList.remove('hint')
  }
}

function showWordSelection(words){
  const c=document.getElementById('wordOptions');c.innerHTML='';
  words.forEach(w=>{const b=document.createElement('div');b.className='word-option';b.textContent=w;
    b.onclick=()=>{G.currentWord=w;document.getElementById('wordSelectOverlay').classList.remove('active');
    updateWordDisplay(true);net.send({type:'word-chosen',wl:w.length,did:myId});startTimer()};c.appendChild(b)});
  document.getElementById('wordSelectOverlay').classList.add('active')
}

function handleWordChosen(msg){
  let m='';for(let i=0;i<msg.wl;i++)m+='_ ';
  document.getElementById('wordDisplay').textContent=m.trim();document.getElementById('wordDisplay').classList.remove('hint');
  if(!amIDrawing())startTimer()
}

function updateWordDisplay(full=false){
  const d=document.getElementById('wordDisplay');
  if(full&&amIDrawing()){d.textContent=G.currentWord;d.classList.remove('hint')}
}

function startTimer(){
  G.timeLeft=G.drawTime;const t=document.getElementById('timer');t.textContent=G.timeLeft;t.className='timer-circle';
  clearInterval(G.timerInterval);G.timerInterval=setInterval(()=>{
    G.timeLeft--;t.textContent=G.timeLeft;
    t.className=G.timeLeft<=10?'timer-circle danger':G.timeLeft<=20?'timer-circle warning':'timer-circle';
    if(G.timeLeft<=5)playTick();
    if(room.hostId===myId){
      if(G.timeLeft===Math.floor(G.drawTime*.5)||G.timeLeft===Math.floor(G.drawTime*.25))sendHint();
      const nd=G.players.filter(p=>p.id!==getDrawerId());
      if(nd.every(p=>G.guessedPlayers.has(p.id))){hostEndTurn(true);return}
      if(G.timeLeft<=0){hostEndTurn(false);return}
    }
    if(G.timeLeft<=0)clearInterval(G.timerInterval)
  },1000)
}

function sendHint(){
  if(!amIDrawing()||!G.currentWord)return;
  const hi=[];for(let i=0;i<G.currentWord.length;i++)if(G.currentWord[i]!==' '&&!G.hintRevealed.includes(i))hi.push(i);
  if(hi.length>0){const idx=hi[Math.floor(Math.random()*hi.length)];G.hintRevealed.push(idx);
    net.send({type:'hint',ci:idx,ch:G.currentWord[idx]});addChat('system','üí° A letter revealed!')}
}

function handleHint(msg){
  G.hintRevealed.push(msg.ci);
  if(!amIDrawing()){const d=document.getElementById('wordDisplay');const parts=d.textContent.split(' ');
    if(msg.ci<parts.length)parts[msg.ci]=msg.ch;d.textContent=parts.join(' ');d.classList.add('hint')}
  addChat('system','üí° A letter revealed!')
}

function hostEndTurn(allGuessed){
  clearInterval(G.timerInterval);
  if(G.guessedPlayers.size>0){const dr=G.players.find(p=>p.id===getDrawerId());if(dr)dr.score+=Math.min(G.guessedPlayers.size*10,50)}
  net.send({type:'turn-end',allGuessed,word:G.currentWord,scores:G.players.map(p=>({...p}))});
  handleTurnEnd({allGuessed,word:G.currentWord,scores:G.players.map(p=>({...p}))})
}

function handleTurnEnd(msg){
  clearInterval(G.timerInterval);playTimeUp();
  document.getElementById('roundResultTitle').textContent=msg.allGuessed?'üéâ Everyone Guessed!':'‚è∞ Time\'s Up!';
  document.getElementById('revealWord').textContent=msg.word||'???';
  G.players=msg.scores||G.players;
  const sd=document.getElementById('roundScores');sd.innerHTML='';
  G.players.forEach(p=>{const it=document.createElement('div');it.className='score-item';it.innerHTML=`<span class="name">${p.avatar} ${p.name}</span><span class="points">${p.score} pts</span>`;sd.appendChild(it)});
  document.getElementById('roundResultOverlay').classList.add('active');renderPlayers();
  setTimeout(()=>{document.getElementById('roundResultOverlay').classList.remove('active');if(room.hostId===myId)hostAdvanceTurn()},3500)
}

function hostAdvanceTurn(){G.turnIndex++;if(G.turnIndex>=G.turnOrder.length){G.turnIndex=0;G.round++;if(G.round>G.totalRounds){hostGameOver();return}G.turnOrder.sort(()=>Math.random()-.5)}hostStartTurn()}
function hostGameOver(){const s=[...G.players].sort((a,b)=>b.score-a.score);net.send({type:'game-over',players:s});handleGameOver({players:s})}

function handleGameOver(msg){
  G.phase='gameover';clearInterval(G.timerInterval);const s=msg.players;
  document.getElementById('winnerName').textContent=s[0].name+' '+s[0].avatar;
  const c=document.getElementById('finalScores');c.innerHTML='';const rl=['gold','silver','bronze'],re=['ü•á','ü•à','ü•â'];
  s.forEach((p,i)=>{const d=document.createElement('div');d.className='final-score-item'+(i===0?' first':'');d.innerHTML=`<div class="final-rank ${rl[i]||''}">${i<3?re[i]:'#'+(i+1)}</div><div class="final-name">${p.avatar} ${p.name}</div><div class="final-points">${p.score}</div>`;c.appendChild(d)});
  document.getElementById('gameOverOverlay').classList.add('active');stopVC()
}

function backToLobby(){document.getElementById('gameOverOverlay').classList.remove('active');clearInterval(G.timerInterval);G.phase='lobby';stopVC();G.players.forEach(p=>p.score=0);room.players=G.players;renderWaiting();showScreen('waitingScreen')}

// ===== GUESSING =====
function handleRemoteGuess(msg){
  if(msg.pid!==myId)addChat('player-msg',msg.guess,msg.pname,msg.isVoice);
  if(amIDrawing()&&G.currentWord){
    const n=msg.guess.toLowerCase().trim(),w=G.currentWord.toLowerCase().trim();
    if(n===w&&!G.guessedPlayers.has(msg.pid)){
      G.guessedPlayers.add(msg.pid);const pts=Math.max(10,60-Math.floor((G.drawTime-G.timeLeft)/G.drawTime*50));
      const p=G.players.find(x=>x.id===msg.pid);if(p)p.score+=pts;playCorrect();
      net.send({type:'guess-correct',playerId:msg.pid,playerName:msg.pname,points:pts,scores:G.players.map(x=>({...x}))});
      addChat('correct',`üéâ ${msg.pname} guessed it! (+${pts})`);renderPlayers()
    }else if(isClose(n,w)){net.send({type:'close-guess',text:`'${msg.guess}' is close!`});addChat('close-guess',`'${msg.guess}' is close!`)}
  }
}

function isClose(g,w){if(g.length<3||w.length<3)return false;if(w.includes(g)||g.includes(w))return true;let d=0;const l=Math.max(g.length,w.length);for(let i=0;i<l;i++)if(g[i]!==w[i])d++;return d<=2&&d>0}

// ===== CANVAS =====
function initCanvas(){canvas=document.getElementById('drawCanvas');ctx=canvas.getContext('2d');resizeCanvas();window.addEventListener('resize',resizeCanvas);
  canvas.addEventListener('mousedown',onD);canvas.addEventListener('mousemove',onM);canvas.addEventListener('mouseup',onU);canvas.addEventListener('mouseleave',onU);
  canvas.addEventListener('touchstart',e=>{e.preventDefault();onD(tM(e))},{passive:false});canvas.addEventListener('touchmove',e=>{e.preventDefault();onM(tM(e))},{passive:false});canvas.addEventListener('touchend',e=>{e.preventDefault();onU()},{passive:false});
  ctx.fillStyle='#fff';ctx.fillRect(0,0,canvas.width,canvas.height);drawHistory=[];saveHistory()}
function resizeCanvas(){const w=document.querySelector('.canvas-wrapper');if(!w)return;const mW=w.clientWidth-16,mH=w.clientHeight-16,r=780/520;let cw=mW,ch=cw/r;if(ch>mH){ch=mH;cw=ch*r}canvas.style.width=cw+'px';canvas.style.height=ch+'px'}
function tM(e){const r=canvas.getBoundingClientRect(),t=e.touches[0];return{offsetX:(t.clientX-r.left)/r.width*canvas.width,offsetY:(t.clientY-r.top)/r.height*canvas.height}}
function gP(e){const r=canvas.getBoundingClientRect();return e.offsetX!==undefined&&e.target===canvas?{x:e.offsetX/r.width*canvas.width,y:e.offsetY/r.height*canvas.height}:{x:e.offsetX,y:e.offsetY}}
function onD(e){if(!amIDrawing())return;drawing=true;const p=gP(e);if(currentTool==='fill'){floodFill(Math.round(p.x),Math.round(p.y),currentColor);saveHistory();net.send({type:'draw-data',action:'fill',data:{x:Math.round(p.x),y:Math.round(p.y),color:currentColor}});return}strokeData=[{x:p.x,y:p.y}];ctx.beginPath();ctx.moveTo(p.x,p.y)}
function onM(e){if(!drawing||!amIDrawing()||currentTool==='fill')return;const p=gP(e);strokeData.push({x:p.x,y:p.y});ctx.lineWidth=currentSize;ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle=currentTool==='eraser'?'#fff':currentColor;ctx.lineTo(p.x,p.y);ctx.stroke();ctx.beginPath();ctx.moveTo(p.x,p.y)}
function onU(){if(!drawing)return;drawing=false;if(strokeData.length>0){saveHistory();net.send({type:'draw-data',action:'stroke',data:{points:strokeData,color:currentTool==='eraser'?'#FFFFFF':currentColor,size:currentSize}});strokeData=[]}}
function saveHistory(){if(!ctx)return;drawHistory.push(ctx.getImageData(0,0,canvas.width,canvas.height));if(drawHistory.length>30)drawHistory.shift()}
function undoDraw(){if(!amIDrawing())return;if(drawHistory.length>1){drawHistory.pop();ctx.putImageData(drawHistory[drawHistory.length-1],0,0);net.send({type:'draw-data',action:'undo',data:canvas.toDataURL('image/png',0.4)})}else{ctx.fillStyle='#fff';ctx.fillRect(0,0,canvas.width,canvas.height);net.send({type:'draw-data',action:'clear'})}}
function clearCanvas(){if(!amIDrawing())return;ctx.fillStyle='#fff';ctx.fillRect(0,0,canvas.width,canvas.height);drawHistory=[];saveHistory();net.send({type:'draw-data',action:'clear'})}
function replayStroke(d){if(!ctx)return;ctx.beginPath();ctx.strokeStyle=d.color;ctx.lineWidth=d.size;ctx.lineCap='round';ctx.lineJoin='round';if(d.points.length>0){ctx.moveTo(d.points[0].x,d.points[0].y);for(let i=1;i<d.points.length;i++)ctx.lineTo(d.points[i].x,d.points[i].y);ctx.stroke()}}
function replayFill(d){floodFill(d.x,d.y,d.color)}
function replayUndo(url){const img=new Image();img.onload=()=>{ctx.drawImage(img,0,0)};img.src=url}
function floodFill(sx,sy,fc){if(!ctx)return;const id=ctx.getImageData(0,0,canvas.width,canvas.height),d=id.data,w=canvas.width,h=canvas.height,st=[[sx,sy]],hex=fc.replace('#',''),fr=parseInt(hex.substr(0,2),16),fg=parseInt(hex.substr(2,2),16),fb=parseInt(hex.substr(4,2),16),idx=(sy*w+sx)*4,tr=d[idx],tg=d[idx+1],tb=d[idx+2];if(fr===tr&&fg===tg&&fb===tb)return;const m=i=>d[i]===tr&&d[i+1]===tg&&d[i+2]===tb;while(st.length>0){const[x,y]=st.pop();if(x<0||x>=w||y<0||y>=h)continue;const i=(y*w+x)*4;if(!m(i))continue;d[i]=fr;d[i+1]=fg;d[i+2]=fb;d[i+3]=255;st.push([x+1,y],[x-1,y],[x,y+1],[x,y-1])}ctx.putImageData(id,0,0)}

// Toolbar
function initToolbar(){const p=document.getElementById('colorPalette');p.innerHTML='';DRAW_COLORS.forEach(c=>{const b=document.createElement('div');b.className='color-btn'+(c==='#000000'?' selected':'');b.style.background=c;if(c==='#FFFFFF')b.style.border='2px solid #555';b.onclick=()=>{p.querySelectorAll('.color-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');currentColor=c;setTool('pencil')};p.appendChild(b)});
  const s=document.getElementById('brushSizes');s.innerHTML='';BRUSH_SIZES.forEach((bs,i)=>{const b=document.createElement('div');b.className='brush-size-btn'+(i===1?' selected':'');b.style.width=(bs.display+10)+'px';b.style.height=(bs.display+10)+'px';const dot=document.createElement('div');dot.className='dot';dot.style.width=bs.display+'px';dot.style.height=bs.display+'px';b.appendChild(dot);b.onclick=()=>{s.querySelectorAll('.brush-size-btn').forEach(x=>x.classList.remove('selected'));b.classList.add('selected');currentSize=bs.size};s.appendChild(b)});setTool('pencil')}
function setTool(t){currentTool=t;document.getElementById('btnPencil').classList.toggle('selected',t==='pencil');document.getElementById('btnEraser').classList.toggle('selected',t==='eraser');document.getElementById('btnFill').classList.toggle('selected',t==='fill')}

// Players
function renderPlayers(){const l=document.getElementById('playersList');if(!l)return;const sorted=G.players.map(p=>({...p})).sort((a,b)=>b.score-a.score);l.innerHTML='';sorted.forEach((p,r)=>{const isD=getDrawerId()===p.id,hasG=G.guessedPlayers.has(p.id),isS=G.speakingPlayers.has(p.id);const c=document.createElement('div');c.className='player-card'+(isD?' drawing':'')+(hasG?' guessed':'')+(isS?' speaking':'');c.innerHTML=`<div class="player-rank">#${r+1}</div><div class="player-avatar">${p.avatar}</div><div class="player-info"><div class="player-name">${p.name}${p.id===myId?' (You)':''}</div><div class="player-score">${p.score} pts</div></div>${isD?'<div class="drawing-indicator">üé®</div>':''}${hasG?'<div class="drawing-indicator">‚úÖ</div>':''}${isS?'<div class="voice-indicator">üéôÔ∏è</div>':''}`;l.appendChild(c)})}

// Chat
function addChat(type,text,author,isVoice=false){const c=document.getElementById('chatMessages');if(!c)return;const d=document.createElement('div');d.className='chat-msg '+type+(isVoice?' voice-msg':'');if(type==='player-msg'){const vb=isVoice?'<span class="voice-badge">VOICE</span>':'';d.innerHTML=`<span class="msg-author" style="color:${pColor(author||'')}">${author||''}${vb}:</span> ${esc(text)}`}else d.textContent=text;c.appendChild(d);c.scrollTop=c.scrollHeight}
function pColor(n){const cs=['#60a5fa','#f472b6','#4ade80','#fbbf24','#a78bfa','#fb923c','#22d3ee','#f87171'];let h=0;for(let i=0;i<n.length;i++)h=n.charCodeAt(i)+((h<<5)-h);return cs[Math.abs(h)%cs.length]}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function switchTab(t){document.getElementById('tabChat').classList.toggle('active',t==='chat');document.getElementById('tabVoice').classList.toggle('active',t==='voice');document.getElementById('chatPanelContent').classList.toggle('hidden',t!=='chat');document.getElementById('voicePanelContent').classList.toggle('active',t==='voice')}

// Audio
function playBeep(f,d){if(!G.soundEnabled)return;try{const a=new(window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.frequency.value=f;g.gain.value=0.1;o.start();g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);o.stop(a.currentTime+d)}catch(e){}}
function playCorrect(){playBeep(880,.15);setTimeout(()=>playBeep(1100,.2),150)}
function playTick(){playBeep(600,.05)}
function playTimeUp(){playBeep(300,.4)}
function toggleSound(){G.soundEnabled=!G.soundEnabled;document.querySelector('.top-bar-right .btn-icon').textContent=G.soundEnabled?'üîä':'üîá'}

// ===== VOICE =====
function initViz(){const v=document.getElementById('voiceVisualizer');if(!v)return;v.innerHTML='';for(let i=0;i<vc.vizBars;i++){const b=document.createElement('div');b.className='viz-bar';b.style.height='3px';v.appendChild(b)}}
function renderVoiceMembers(){const c=document.getElementById('voiceMembers');if(!c)return;c.innerHTML='';G.players.forEach(p=>{const isS=G.speakingPlayers.has(p.id);const d=document.createElement('div');d.className='voice-member'+(isS?' speaking-active':'');d.innerHTML=`<div class="voice-member-avatar">${p.avatar}<div class="voice-ring"></div></div><div class="voice-member-info"><div class="voice-member-name">${p.name}${p.id===myId?' (You)':''}</div><div class="voice-member-status">${isS?'üéôÔ∏è Speaking...':(p.id===myId&&vc.isListening?'üéôÔ∏è Mic on':'In room')}</div></div>`;c.appendChild(d)})}
function toggleMic(){vc.isListening?stopVC():startVC()}
async function startVC(){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){addChat('system','‚ö†Ô∏è Speech recognition not supported. Try Chrome!');return}
  try{vc.mediaStream=await navigator.mediaDevices.getUserMedia({audio:true});vc.audioContext=new(window.AudioContext||window.webkitAudioContext)();const src=vc.audioContext.createMediaStreamSource(vc.mediaStream);vc.analyser=vc.audioContext.createAnalyser();vc.analyser.fftSize=64;src.connect(vc.analyser);
  vc.recognition=new SR();vc.recognition.continuous=true;vc.recognition.interimResults=true;vc.recognition.lang='en-US';
  vc.recognition.onresult=e=>{let interim='',final='';for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)final+=t;else interim+=t}
    const te=document.getElementById('voiceTranscript');if(interim){te.textContent=`üéôÔ∏è "${interim}"`;te.classList.add('active');net.send({type:'speaking',pid:myId,on:true})}
    if(final){const g=final.trim();te.textContent=`‚úÖ "${g}"`;te.classList.add('active');setTimeout(()=>{te.classList.remove('active');te.textContent='Listening...'},2000);net.send({type:'speaking',pid:myId,on:false});
      if(g&&!amIDrawing()&&!G.guessedPlayers.has(myId)){net.send({type:'guess',pid:myId,pname:myName,guess:g,isVoice:true});addChat('player-msg',g,myName,true)}}};
  vc.recognition.onerror=e=>{if(e.error==='no-speech'||e.error==='aborted')return};
  vc.recognition.onend=()=>{if(vc.isListening&&vc.mode==='toggle')try{vc.recognition.start()}catch(e){}};
  vc.connected=true;vc.isListening=true;if(vc.mode==='toggle')vc.recognition.start();
  updateVUI();startVA();addChat('system','üéôÔ∏è Voice connected!');document.getElementById('voiceStatusDot').classList.add('connected');document.getElementById('voiceStatusText').textContent='Connected'}
  catch(e){addChat('system','‚ö†Ô∏è Mic access denied.');document.getElementById('voiceStatusDot').className='voice-status-dot error'}}
function startListening(){if(!vc.recognition||!vc.connected)return;try{vc.recognition.start();vc.isListening=true;updateVUI()}catch(e){}}
function stopListening(){if(!vc.recognition)return;try{vc.recognition.stop();if(vc.mode==='ptt'){vc.isListening=false;updateVUI()}}catch(e){}}
function stopVC(){if(vc.recognition)try{vc.recognition.stop()}catch(e){}vc.recognition=null;if(vc.mediaStream){vc.mediaStream.getTracks().forEach(t=>t.stop());vc.mediaStream=null}if(vc.audioContext){vc.audioContext.close();vc.audioContext=null}if(vc.vizAnimFrame){cancelAnimationFrame(vc.vizAnimFrame);vc.vizAnimFrame=null}vc.isListening=false;vc.connected=false;vc.analyser=null;updateVUI();document.getElementById('voiceStatusDot').className='voice-status-dot';document.getElementById('voiceStatusText').textContent='Disconnected';const vt=document.getElementById('voiceTranscript');if(vt){vt.textContent='Press mic to start';vt.classList.remove('active')}renderVoiceMembers();resetVB()}
function updateVUI(){const b=document.getElementById('btnMic'),l=document.getElementById('micBtnLabel');if(!b)return;if(vc.isListening){b.classList.add('mic-active','listening');l.textContent=vc.mode==='ptt'?'Talking...':'Listening...'}else if(vc.connected){b.classList.add('mic-active');b.classList.remove('listening');l.textContent=vc.mode==='ptt'?'Hold Space':'Mic On'}else{b.classList.remove('mic-active','listening');l.textContent='Start Mic'}document.getElementById('voiceHint').textContent=vc.connected?(vc.mode==='ptt'?'Hold SPACE to talk':'Speak guesses ‚Äî auto-submitted!'):'Speak guesses ‚Äî voice auto-submits!'}
function toggleVoiceMode(m){vc.mode=m;document.getElementById('modeToggle').classList.toggle('active',m==='toggle');document.getElementById('modePTT').classList.toggle('active',m==='ptt');if(vc.connected){if(m==='toggle')try{vc.recognition.start();vc.isListening=true}catch(e){}else try{vc.recognition.stop();vc.isListening=false}catch(e){}updateVUI()}}
function toggleMute(){vc.isMuted=!vc.isMuted;document.getElementById('btnMute').textContent=vc.isMuted?'üîá':'üîà';document.getElementById('btnMute').classList.toggle('active',vc.isMuted)}
function startVA(){if(!vc.analyser)return;const bars=document.querySelectorAll('#voiceVisualizer .viz-bar'),bl=vc.analyser.frequencyBinCount,da=new Uint8Array(bl);function a(){if(!vc.analyser)return;vc.vizAnimFrame=requestAnimationFrame(a);vc.analyser.getByteFrequencyData(da);const step=Math.floor(bl/bars.length);for(let i=0;i<bars.length;i++){const v=da[i*step]||0,h=Math.max(3,(v/255)*36);bars[i].style.height=h+'px';bars[i].style.background=v/255>.3?`hsl(${260+(v/255)*40},80%,${50+(v/255)*20}%)`:'var(--border)'}}a()}
function resetVB(){document.querySelectorAll('#voiceVisualizer .viz-bar').forEach(b=>{b.style.height='3px';b.style.background='var(--border)'})}

// DOMContentLoaded
document.addEventListener('DOMContentLoaded',()=>{initAvatars();initViz();
  document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'){const i=e.target,g=i.value.trim();if(!g)return;i.value='';if(amIDrawing()||G.guessedPlayers.has(myId))return;net.send({type:'guess',pid:myId,pname:myName,guess:g,isVoice:false});addChat('player-msg',g,myName,false)}});
  document.addEventListener('keydown',e=>{if(e.code==='Space'&&vc.mode==='ptt'&&vc.connected&&!vc.pttHeld){const af=document.activeElement;if(af&&(af.tagName==='INPUT'||af.tagName==='SELECT'))return;e.preventDefault();vc.pttHeld=true;startListening()}});
  document.addEventListener('keyup',e=>{if(e.code==='Space'&&vc.mode==='ptt'&&vc.pttHeld){e.preventDefault();vc.pttHeld=false;stopListening()}})});
window.addEventListener('beforeunload',()=>{net.send({type:'player-left',pid:myId,pname:myName})});
</script>
</body>
</html>
